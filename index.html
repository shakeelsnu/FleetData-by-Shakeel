<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Search Dashboard</title>
  <style>
    :root {
      --bg-color: linear-gradient(to right, #f0f8ff, #e6f7ff);
      --text-color: #333;
      --button-color: #007acc;
      --button-hover-color: #005f99;
      --font-family: 'Segoe UI', sans-serif;
      --header-color: #007acc;
      --table-header-bg: #e0f0ff;
      --table-border: #ddd;
      --result-bg: #f9f9f9;
    }
    body { 
      font-family: var(--font-family); 
      background: var(--bg-color); 
      color: var(--text-color); 
      padding: 10px; 
      margin: 0;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 5px;
    }
    h1 { 
      color: var(--header-color); 
      margin-bottom: 2px; 
      font-size: 1.8rem;
    }
    .author { 
      color: #888; 
      font-size: 0.9em; 
      margin-top: 0; 
      margin-bottom: 10px; 
    }
    input[type="text"], input[type="password"] { 
      padding: 10px; 
      margin: 5px 0; 
      border: 2px solid var(--button-color); 
      border-radius: 5px; 
      box-sizing: border-box;
      font-size: 16px;
      background: white;
      color: #333;
    }
    #userName {
      width: 150px;
      padding: 8px 12px;
    }
    #userName:focus {
      width: 100%;
    }
    #mainContent h3 {
        font-size: 1.2em;
        margin-bottom: 3px;
    }
    .search-inputs {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    #searchInput {
      width: 250px;
      padding: 8px 12px;
    }
    #searchInput:focus {
      flex: 1;
      width: 100%;
    }
    select#fileSelect {
      padding: 8px 12px;
      margin: 5px 0;
      border: 2px solid var(--button-color);
      border-radius: 5px;
      font-size: 16px;
      background: white;
      color: #333;
    }
    button { 
      padding: 10px 15px; 
      margin: 5px; 
      border: none; 
      border-radius: 5px; 
      background-color: var(--button-color); 
      color: white; 
      cursor: pointer; 
      font-size: 16px;
    }
    button:hover { 
      background-color: var(--button-hover-color); 
    }
    .hidden { 
      display: none; 
    }
    #results, #adminPanel, #adminLogin { 
      margin-top: 15px; 
      background-color: var(--result-bg); 
      padding: 15px; 
      border-radius: 8px; 
    }
    table { 
      min-width: 600px;
      border-collapse: collapse; 
      margin-bottom: 5px; 
      width: 100%;
      border: 1px solid var(--table-border);
    }
    th, td { 
      border: 1px solid var(--table-border); 
      padding: 8px; 
      text-align: left; 
      font-size: 0.9rem;
      line-height: 1.2;
    }
    th { 
      background-color: var(--table-header-bg); 
      font-weight: bold; 
      cursor: pointer; 
      white-space: nowrap;
      position: relative;
    }
    th:hover { 
      background-color: #c9e5ff; 
    }
    th::after { 
      content: '↕'; 
      position: absolute; 
      right: 8px; 
      top: 50%; 
      transform: translateY(-50%); 
      font-size: 0.8em; 
      opacity: 0.5; 
    }
    th.asc::after { 
      content: '↑'; 
      opacity: 1; 
    }
    th.desc::after { 
      content: '↓'; 
      opacity: 1; 
    }
    #timestamp { 
      margin-top: 15px; 
      font-style: italic; 
      color: #555; 
      font-size: 0.9rem;
    }
    .error { 
      color: red; 
      margin-top: 3px; 
      font-weight: bold;
    }
    .highlight-0 { background-color: #FFFF00; font-weight: bold; }
    .highlight-1 { background-color: #00FF00; font-weight: bold; }
    .highlight-2 { background-color: #00FFFF; font-weight: bold; }
    .highlight-3 { background-color: #FF00FF; font-weight: bold; color: white; }
    .highlight-4 { background-color: #FF8000; font-weight: bold; }
    .highlight-5 { background-color: #FF0080; font-weight: bold; color: white; }
    .file-selector { 
      margin: 10px 0; 
    }
    .file-selector label { 
      font-weight: bold; 
      display: block; 
      margin-bottom: 3px; 
      font-size: 1.1rem;
    }
    .file-nickname { 
      display: flex; 
      align-items: center; 
      margin-bottom: 5px; 
      flex-wrap: wrap;
    }
    .file-nickname input { 
      margin-right: 8px; 
      flex: 1;
      min-width: 150px;
    }
    .admin-section { 
      margin-top: 15px; 
      padding: 10px; 
      background-color: #f0f8ff; 
      border-radius: 8px; 
    }
    .admin-tools { 
      margin-top: 15px; 
      padding: 10px; 
      background-color: #fff0f0; 
      border-radius: 8px; 
    }
    .password-prompt { 
      margin-top: 10px; 
      padding: 8px; 
      background-color: #fff9e6; 
      border-radius: 5px; 
      border: 1px solid #ffcc00; 
    }
    .admin-header { 
      text-decoration: underline; 
      margin-bottom: 10px; 
      color: #007acc;
      font-size: 1.2rem;
    }
    .selection-controls { 
      margin: 8px 0; 
    }
    .log-row { 
      transition: background-color 0.2s; 
    }
    .log-row:hover { 
      background-color: #f5f5f5; 
    }
    .selected { 
      background-color: #e6f7ff !important; 
    }
    .table-container { 
      position: relative; 
      overflow-x: auto;
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #selectAllLogs { 
      margin-right: 8px; 
    }
    .selected-files { 
      margin-top: 8px; 
      font-style: italic; 
      color: #555; 
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .admin-button {
      background-color: #8e44ad;
    }
    .logout-button {
      background-color: #ff6b6b;
    }
    .search-button {
      background-color: #27ae60;
    }
    .export-button {
      background-color: #9b59b6;
    }
    .export-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .delete-selected-container {
      margin-top: 10px;
      padding: 8px;
      background-color: #fff0f0;
      border-radius: 5px;
      border: 1px solid #ff6b6b;
    }
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      h1 {
        font-size: 1.5rem;
      }
      .search-inputs {
        flex-direction: column;
        gap: 3px;
      }
      input[type="text"], input[type="password"], select {
        font-size: 14px;
        padding: 8px;
      }
      button {
        width: 100%;
        margin: 3px 0;
        padding: 8px 12px;
        font-size: 14px;
      }
      .button-group {
        flex-direction: column;
        gap: 3px;
      }
      #results, #adminPanel, #adminLogin {
        padding: 10px;
        margin-top: 10px;
      }
      th, td {
        padding: 6px 4px;
        font-size: 0.8rem;
      }
      .admin-header {
        font-size: 1.1rem;
      }
      .export-options {
        flex-direction: column;
      }
      .table-container {
        max-height: 60vh;
      }
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 15px;
        border: 1px solid #888;
        width: 80%;
        max-height: 90%;
        overflow-y: auto;
        border-radius: 8px;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 24px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .modal-actions {
        margin-top: 15px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }
    #previewTableContainer {
        max-height: 400px;
        overflow-y: auto;
    }
    .top-buttons {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .refresh-button {
      background-color: #3498db;
    }
    .search-options-panel {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
    }
    .search-options-header {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .search-type-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .search-type-option {
      display: flex;
      align-items: center;
    }
    .search-type-option input {
      margin-right: 3px;
    }
    .column-selector {
      margin-top: 10px;
    }
    .column-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 5px;
      max-height: 120px;
      overflow-y: auto;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 5px;
      background-color: white;
    }
    .column-checkbox {
      display: flex;
      align-items: center;
    }
    .column-checkbox input {
      margin-right: 5px;
    }
    .mobile-view-toggle {
      background-color: #9b59b6;
    }
    .column-visibility-controls {
      background-color: #f0f8ff;
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      border: 1px solid #cce7ff;
    }
    .column-visibility-header {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .visibility-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .visibility-checkbox {
      display: flex;
      align-items: center;
      background: white;
      padding: 3px 8px;
      border-radius: 3px;
      border: 1px solid #ddd;
    }
    .visibility-checkbox input {
      margin-right: 3px;
    }
    /* Customization panel styles */
    .customization-panel {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      max-width: 300px;
    }
    .customization-header {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .customization-option {
      margin-bottom: 10px;
    }
    .customization-option label {
      display: block;
      margin-bottom: 3px;
      font-size: 0.9rem;
    }
    .customization-option input[type="color"] {
      width: 100%;
      height: 30px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .customization-option select {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .customization-toggle {
      background-color: #f39c12;
    }
    /* Excel-style filter dropdown styles */
    .filter-dropdown {
      position: relative;
      display: inline-block;
    }
    .filter-button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 5px;
      margin-left: 5px;
      border-radius: 3px;
      color: #666;
    }
    .filter-button:hover {
      background-color: #e0e0e0;
    }
    .filter-dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 200px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1000;
      border-radius: 4px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      left: 0;
      top: 100%;
    }
    .filter-dropdown-content.show {
      display: block;
    }
    .filter-search {
      width: 100%;
      padding: 5px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 12px;
    }
    .filter-options {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 8px;
    }
    .filter-option {
      display: flex;
      align-items: center;
      margin-bottom: 3px;
      font-size: 12px;
    }
    .filter-option input {
      margin-right: 5px;
    }
    .filter-actions {
      display: flex;
      justify-content: space-between;
      gap: 5px;
    }
    .filter-actions button {
      padding: 5px 10px;
      font-size: 12px;
      flex: 1;
    }
    /* Filter indicator styles */
    .filter-indicator {
      display: inline-block;
      background-color: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      text-align: center;
      line-height: 16px;
      margin-left: 5px;
    }
    .filtered-column {
      background-color: #fff3cd !important;
      border-left: 3px solid #ffc107;
    }
    .active-filters-panel {
      background-color: #e8f4fd;
      border: 1px solid #b8daff;
      border-radius: 5px;
      padding: 8px 12px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .active-filter-tag {
      background-color: #007acc;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .active-filter-tag .remove-filter {
      cursor: pointer;
      font-weight: bold;
    }
    .clear-filters-button {
      background-color: #e74c3c;
      padding: 6px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <button onclick="location.reload()" class="refresh-button">🔄 Refresh</button>
      <button onclick="toggleMobileView()" class="mobile-view-toggle" id="mobileViewToggle">📱 Mobile View</button>
      <button onclick="toggleCustomizationPanel()" class="customization-toggle">🎨 Customize</button>
    </div>
    
    <!-- Customization Panel -->
    <div id="customizationPanel" class="customization-panel hidden">
      <div class="customization-header">
        <span>🎨 Customize Appearance</span>
        <button onclick="toggleCustomizationPanel()" style="background: none; border: none; font-size: 16px; cursor: pointer;">✕</button>
      </div>
      <div class="customization-option">
        <label for="themeColor">Theme Color</label>
        <input type="color" id="themeColor" value="#007acc" onchange="updateThemeColor(this.value)">
      </div>
      <div class="customization-option">
        <label for="backgroundColor">Background Color</label>
        <input type="color" id="backgroundColor" value="#f0f8ff" onchange="updateBackgroundColor(this.value)">
      </div>
      <div class="customization-option">
        <label for="fontFamily">Font Family</label>
        <select id="fontFamily" onchange="updateFontFamily(this.value)">
          <option value="'Segoe UI', sans-serif">Segoe UI</option>
          <option value="Arial, sans-serif">Arial</option>
          <option value="'Helvetica Neue', sans-serif">Helvetica</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
        </select>
      </div>
      <div class="customization-option">
        <label for="tableRowHeight">Table Row Height</label>
        <select id="tableRowHeight" onchange="updateTableRowHeight(this.value)">
          <option value="compact">Compact</option>
          <option value="normal" selected>Normal</option>
          <option value="spacious">Spacious</option>
        </select>
      </div>
      <div class="button-group">
        <button onclick="applyCustomization()" style="background-color: #27ae60;">Apply Changes</button>
        <button onclick="resetCustomization()" style="background-color: #95a5a6;">Reset to Default</button>
      </div>
    </div>

    <h1>📊 Excel Search Dashboard</h1>
    <p class="author">by Shakeel</p>
    <div id="userAuth">
      <h3>Please Enter Your Name to Continue</h3>
      <input type="text" id="userName" placeholder="Enter your name (letters only)..." />
      <div id="nameError" class="error hidden">Please enter a valid name (letters only, no numbers or special characters)</div>
      <div class="button-group">
        <button onclick="setUserName()">Continue</button>
        <button onclick="toggleAdminLogin()" class="admin-button">Admin Mode</button>
      </div>
    </div>
    <div id="mainContent" class="hidden">
      <p id="timestamp">Page loaded: <span id="lastUpdated"></span></p>
      <div class="export-options">
          <button onclick="handleExportClick('excel')" class="export-button">📊 Export to Excel</button>
          <button onclick="handleExportClick('pdf')" class="export-button">📄 Export to PDF</button>
          <button onclick="handleExportClick('csv')" class="export-button">📝 Export to CSV</button>
          <button onclick="handleExportClick('print')" class="export-button">🖨️ Print</button>
      </div>
      <div class="search-inputs">
        <div class="file-selector">
          <label for="fileSelect">📁 Select Files:</label>
          <select id="fileSelect">
            <option value="" selected disabled>-- Loading files... --</option>
            <option value="all">All Files</option>
          </select>
        </div>
        <div class="search-options-panel">
          <div class="search-options-header">
            <span>🔍 Search Options</span>
          </div>
          <div class="search-type-selector">
            <div class="search-type-option">
              <input type="radio" id="searchTypeContains" name="searchType" value="contains" checked>
              <label for="searchTypeContains">Contains</label>
            </div>
            <div class="search-type-option">
              <input type="radio" id="searchTypeExact" name="searchType" value="exact">
              <label for="searchTypeExact">Exact Match</label>
            </div>
            <div class="search-type-option">
              <input type="radio" id="searchTypeStartsWith" name="searchType" value="startsWith">
              <label for="searchTypeStartsWith">Starts With</label>
            </div>
            <div class="search-type-option">
              <input type="radio" id="searchTypeEndsWith" name="searchType" value="endsWith">
              <label for="searchTypeEndsWith">Ends With</label>
            </div>
          </div>
          <div class="column-selector">
            <label><strong>🔍 Search in Specific Columns:</strong></label>
            <div class="column-checkboxes" id="columnCheckboxes">
              <p>Select files first to see available columns</p>
            </div>
            <div class="button-group" style="margin-top: 8px;">
              <button onclick="selectAllColumns()">Select All Columns</button>
              <button onclick="deselectAllColumns()">Deselect All Columns</button>
            </div>
          </div>
        </div>
        <input type="text" id="searchInput" placeholder="Search keywords separated by commas..." />
      </div>
      <div class="button-group">
        <button onclick="performSearch()" class="search-button" id="searchButton">Search</button>
        <button onclick="toggleAdminLogin()" class="admin-button">Admin Mode</button>
        <button onclick="logout()" class="logout-button">Logout</button>
      </div>
      <div id="results" class="hidden">
        <p><strong>Excel Sources Loaded:</strong> <span id="excelUploadDate">Fetching...</span></p>
        <p>Total Matches: <span id="totalMatches">0</span></p>
        <p id="perTermMatches"></p>
        
        <!-- Active Filters Panel -->
        <div id="activeFiltersPanel" class="active-filters-panel hidden">
          <strong>Active Filters:</strong>
          <div id="activeFiltersList"></div>
          <button onclick="clearAllFilters()" class="clear-filters-button">Clear All Filters</button>
        </div>
        
        <div class="column-visibility-controls" id="columnVisibilityControls" style="display: none;">
          <div class="column-visibility-header">
            <span>👁️ Show/Hide Columns</span>
            <div class="button-group" style="margin: 0;">
              <button onclick="showAllColumns()" style="padding: 3px 8px; font-size: 12px;">Show All</button>
              <button onclick="hideAllColumns()" style="padding: 3px 8px; font-size: 12px;">Hide All</button>
            </div>
          </div>
          <div class="visibility-checkboxes" id="visibilityCheckboxes"></div>
        </div>
        <h3>🔎 Search Results</h3>
        <div class="table-container">
          <div id="resultText"></div>
        </div>
      </div>
    </div>
    <div id="adminLogin" class="hidden">
      <h3>🔐 Admin Login</h3>
      <input type="text" id="adminUser" placeholder="Username" />
      <input type="password" id="adminPass" placeholder="Password" />
      <div class="button-group">
        <button onclick="checkAdminLogin()">Login</button>
        <button onclick="toggleAdminLogin()" class="logout-button">Cancel</button>
      </div>
    </div>
    <div id="adminPanel" class="hidden">
      <h3 class="admin-header">📋 Admin Panel - User Activity Logs</h3>
      <button onclick="hideAdminPanel()" class="logout-button" style="margin-bottom: 10px;">Close Admin Panel</button>
      <div class="admin-tools">
        <h3 class="admin-header">🛠️ Admin Tools</h3>
        <div class="button-group">
          <button onclick="exportUserLogs()">📝 Export Logs as Text</button>
          <button onclick="showDeleteConfirmation()" class="logout-button">🗑️ Delete All Logs</button>
        </div>
        <div class="selection-controls">
          <label><input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs(this.checked)"> Select All</label>
        </div>
        <div id="deleteSelectedContainer" class="delete-selected-container hidden">
          <p><strong><span id="selectedCount">0</span> log(s) selected</strong></p>
          <button onclick="deleteSelectedLogs()" class="logout-button">🗑️ Delete Selected</button>
        </div>
        <div id="deleteConfirmation" class="password-prompt hidden">
          <h4>Confirm Deletion</h4>
          <p>This will permanently delete all selected user logs. This action cannot be undone.</p>
          <input type="password" id="deletePassword" placeholder="Enter admin password to confirm" />
          <div class="button-group">
            <button onclick="deleteAllLogs()" class="logout-button">Confirm Delete All</button>
            <button onclick="hideDeleteConfirmation()">Cancel</button>
          </div>
        </div>
      </div>
      <div class="table-container">
        <table id="adminLogsTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>User Name</th>
              <th>Login Time</th>
              <th>Logout Time</th>
              <th>Duration</th>
              <th>Search Count</th>
              <th>Last Search</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
      <div class="admin-section">
        <h3 class="admin-header">📁 File Management - Set Nicknames</h3>
        <div id="fileNicknameManager"></div>
        <div class="button-group">
          <button onclick="saveFileNicknames()">💾 Save Nicknames</button>
          <button onclick="resetFileNicknames()" class="logout-button">🔄 Reset to Default</button>
        </div>
      </div>
    </div>
  </div>
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeExportPreview()">&times;</span>
      <h3>Export Preview (<span id="previewType"></span>)</h3>
      <p id="previewMessage"></p>
      <div id="previewTableContainer"></div>
      <div class="modal-actions">
        <button onclick="closeExportPreview()">Cancel</button>
        <button id="confirmExportBtn">Confirm Export</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    let excelData = [];
    let availableFiles = [];
    let fileNicknames = {};
    let searchLogs = [];
    let userSessions = [];
    let currentResults = [];
    let currentUserName = "";
    let currentUserLoginTime = null;
    let userSearchCount = 0;
    let userLastSearch = "";
    const highlightColors = ["highlight-0", "highlight-1", "highlight-2", "highlight-3", "highlight-4", "highlight-5"];
    let sortColumn = null;
    let sortDirection = 'asc';
    let selectedLogs = new Set();
    let currentExportType = null;
    let availableColumns = [];
    let isMobileView = false;
    const GITHUB_REPO_URL = "https://api.github.com/repos/shakeelsnu/FleetData-by-Shakeel/contents/";
    const GITHUB_RAW_URL = "https://raw.githubusercontent.com/shakeelsnu/FleetData-by-Shakeel/main/";
    let columnVisibility = {};
    let columnFilters = {};
    let activeFilterDropdown = null;

    // Customization variables
    let customizationSettings = {
      themeColor: '#007acc',
      backgroundColor: '#f0f8ff',
      fontFamily: "'Segoe UI', sans-serif",
      tableRowHeight: 'normal'
    };

    // Initialize when the page loads
    window.onload = async function() {
      document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
      loadUserData();
      loadCustomizationSettings();
      
      // Add event listeners
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
      });
      document.getElementById('userName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') setUserName();
      });
      document.getElementById('adminPass').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') checkAdminLogin();
      });
      
      // Search type change handler
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          let hint = "";
          switch(this.value) {
            case "contains": hint = "Search for text that contains your keywords"; break;
            case "exact": hint = "Search for exact matches of your keywords"; break;
            case "startsWith": hint = "Search for text that starts with your keywords"; break;
            case "endsWith": hint = "Search for text that ends with your keywords"; break;
          }
          document.getElementById('searchInput').placeholder = hint;
        });
      });
      
      checkMobileDevice();
      await loadFilesFromGitHub();
      window.addEventListener('resize', checkMobileDevice);
    };

    // Load files from GitHub
    async function loadFilesFromGitHub() {
      try {
        const response = await fetch(GITHUB_REPO_URL);
        if (!response.ok) throw new Error('Failed to fetch files');
        const files = await response.json();
        
        // Filter for data files
        availableFiles = files.filter(file => 
          file.name.toLowerCase().endsWith('.xlsx') || 
          file.name.toLowerCase().endsWith('.xls') ||
          file.name.toLowerCase().endsWith('.csv')
        );
        
        // Set default nicknames
        availableFiles.forEach(file => {
          const simpleName = file.name.replace('.xlsx', '').replace('.xls', '').replace('.csv', '').replace(/_/g, ' ');
          fileNicknames[file.name] = simpleName;
        });
        
        updateFileSelect();
        
        if (availableFiles.length > 0) {
          await loadDataFromGitHub(availableFiles[0].name);
        }
      } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('fileSelect').innerHTML = '<option value="" selected disabled>-- Error loading files --</option>';
      }
    }

    // Load data from GitHub
    async function loadDataFromGitHub(filename) {
      try {
        const rawUrl = `${GITHUB_RAW_URL}${filename}`;
        const response = await fetch(rawUrl);
        
        if (!response.ok) throw new Error('Failed to fetch file');
        
        excelData = [];
        
        if (filename.toLowerCase().endsWith('.csv')) {
          const csvText = await response.text();
          const lines = csvText.split('\n');
          if (lines.length > 0) {
            const headers = lines[0].split(',').map(h => h.trim());
            for (let i = 1; i < lines.length; i++) {
              if (lines[i].trim()) {
                const values = lines[i].split(',').map(v => v.trim());
                const rowData = {};
                headers.forEach((header, index) => {
                  if (header && values[index] !== undefined) {
                    rowData[header] = values[index];
                  }
                });
                if (Object.keys(rowData).length > 0) {
                  rowData.__sourceFile = filename;
                  excelData.push(rowData);
                }
              }
            }
          }
        } else {
          const arrayBuffer = await response.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });
          
          workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            if (jsonData.length > 0) {
              const headers = jsonData[0];
              for (let i = 1; i < jsonData.length; i++) {
                const rowData = {};
                const row = jsonData[i];
                headers.forEach((header, index) => {
                  if (header && row[index] !== undefined) {
                    rowData[header] = row[index];
                  }
                });
                if (Object.keys(rowData).length > 0) {
                  rowData.__sourceFile = filename;
                  excelData.push(rowData);
                }
              }
            }
          });
        }
        
        document.getElementById('excelUploadDate').textContent = `Loaded ${excelData.length} records from ${filename}`;
        updateColumnCheckboxes();
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('excelUploadDate').textContent = `Error loading data from ${filename}`;
      }
    }

    // Update file select dropdown
    function updateFileSelect() {
      const fileSelect = document.getElementById('fileSelect');
      fileSelect.innerHTML = '<option value="" selected disabled>-- Select files to search --</option><option value="all">All Files</option>';
      availableFiles.forEach(file => {
        const option = document.createElement('option');
        option.value = file.name;
        option.textContent = fileNicknames[file.name] || file.name;
        fileSelect.appendChild(option);
      });
      
      fileSelect.addEventListener('change', async function() {
        const selectedValue = this.value;
        if (selectedValue === 'all') {
          await loadAllDataFromGitHub();
        } else if (selectedValue) {
          await loadDataFromGitHub(selectedValue);
        }
        updateColumnCheckboxes();
      });
    }

    // Load all data files
    async function loadAllDataFromGitHub() {
      try {
        excelData = [];
        for (const file of availableFiles) {
          await loadDataFromGitHub(file.name);
        }
        document.getElementById('excelUploadDate').textContent = `Loaded data from ${availableFiles.length} files`;
      } catch (error) {
        console.error('Error loading all data:', error);
      }
    }

    // User authentication
    function setUserName() {
      const nameInput = document.getElementById('userName');
      const nameError = document.getElementById('nameError');
      const name = nameInput.value.trim();
      
      if (!name || !/^[a-zA-Z\s]+$/.test(name)) {
        nameError.classList.remove('hidden');
        return;
      }
      
      nameError.classList.add('hidden');
      currentUserName = name;
      currentUserLoginTime = new Date();
      
      userSessions.push({
        userName: currentUserName,
        loginTime: currentUserLoginTime,
        logoutTime: null,
        searchCount: 0,
        lastSearch: ""
      });
      
      saveUserData();
      document.getElementById('userAuth').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      logUserActivity(`${currentUserName} logged in`);
    }

    function logout() {
      const currentSession = userSessions.find(session => 
        session.userName === currentUserName && session.logoutTime === null);
      
      if (currentSession) {
        currentSession.logoutTime = new Date();
        currentSession.duration = Math.round((currentSession.logoutTime - currentSession.loginTime) / 1000);
      }
      
      saveUserData();
      logUserActivity(`${currentUserName} logged out`);
      
      currentUserName = "";
      currentUserLoginTime = null;
      userSearchCount = 0;
      userLastSearch = "";
      
      document.getElementById('userAuth').classList.remove('hidden');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('results').classList.add('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminLogin').classList.add('hidden');
      document.getElementById('searchInput').value = "";
    }

    // Admin functions
    function toggleAdminLogin() {
      const adminLogin = document.getElementById('adminLogin');
      const mainContent = document.getElementById('mainContent');
      
      if (adminLogin.classList.contains('hidden')) {
        adminLogin.classList.remove('hidden');
        mainContent.classList.add('hidden');
      } else {
        adminLogin.classList.add('hidden');
        mainContent.classList.remove('hidden');
      }
    }

    function checkAdminLogin() {
      const username = document.getElementById('adminUser').value;
      const password = document.getElementById('adminPass').value;
      
      if (username.toLowerCase() === 'shakeel' && password === '9332') {
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
        loadAdminData();
        logUserActivity("Admin logged in");
      } else {
        alert("Invalid admin credentials!");
      }
    }

    function hideAdminPanel() {
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('adminUser').value = "";
      document.getElementById('adminPass').value = "";
      logUserActivity("Admin logged out");
    }

    function loadAdminData() {
      updateAdminLogsTable();
      updateFileNicknameManager();
    }

    function updateAdminLogsTable() {
      const logTable = document.getElementById('logTable');
      logTable.innerHTML = '';
      
      userSessions.forEach((session, index) => {
        const row = document.createElement('tr');
        row.className = 'log-row';
        
        let duration = 'Active';
        if (session.logoutTime) {
          const diffMs = new Date(session.logoutTime) - new Date(session.loginTime);
          const diffMins = Math.round(diffMs / 60000);
          duration = `${diffMins} min`;
        }
        
        row.innerHTML = `
          <td><input type="checkbox" class="log-checkbox" onchange="toggleLogSelection(${index}, this.checked)"></td>
          <td>${session.userName}</td>
          <td>${new Date(session.loginTime).toLocaleString()}</td>
          <td>${session.logoutTime ? new Date(session.logoutTime).toLocaleString() : 'Active'}</td>
          <td>${duration}</td>
          <td>${session.searchCount || 0}</td>
          <td>${session.lastSearch || 'None'}</td>
        `;
        
        logTable.appendChild(row);
      });
    }

    function toggleLogSelection(index, checked) {
      if (checked) {
        selectedLogs.add(index);
      } else {
        selectedLogs.delete(index);
      }
      updateSelectedLogsDisplay();
    }

    function toggleSelectAllLogs(checked) {
      const checkboxes = document.querySelectorAll('.log-checkbox');
      selectedLogs.clear();
      
      checkboxes.forEach((checkbox, index) => {
        checkbox.checked = checked;
        if (checked) selectedLogs.add(index);
      });
      
      updateSelectedLogsDisplay();
    }

    function updateSelectedLogsDisplay() {
      const selectedCount = document.getElementById('selectedCount');
      const deleteSelectedContainer = document.getElementById('deleteSelectedContainer');
      
      selectedCount.textContent = selectedLogs.size;
      
      if (selectedLogs.size > 0) {
        deleteSelectedContainer.classList.remove('hidden');
      } else {
        deleteSelectedContainer.classList.add('hidden');
      }
    }

    function deleteSelectedLogs() {
      if (selectedLogs.size === 0) {
        alert("No logs selected for deletion");
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${selectedLogs.size} selected log(s)? This action cannot be undone.`)) {
        return;
      }
      
      const indicesToDelete = Array.from(selectedLogs).sort((a, b) => b - a);
      indicesToDelete.forEach(index => userSessions.splice(index, 1));
      
      selectedLogs.clear();
      saveUserData();
      updateAdminLogsTable();
      updateSelectedLogsDisplay();
      
      alert(`${indicesToDelete.length} log(s) deleted successfully`);
    }

    function showDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.remove('hidden');
    }

    function hideDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.add('hidden');
      document.getElementById('deletePassword').value = '';
    }

    function deleteAllLogs() {
      const password = document.getElementById('deletePassword').value;
      
      if (password !== '9332') {
        alert("Incorrect admin password");
        return;
      }
      
      if (!confirm("Are you sure you want to delete ALL user logs? This action cannot be undone.")) {
        return;
      }
      
      userSessions = [];
      saveUserData();
      updateAdminLogsTable();
      hideDeleteConfirmation();
      
      alert("All user logs have been deleted");
    }

    function exportUserLogs() {
      let logText = "User Activity Logs\nGenerated: " + new Date().toLocaleString() + "\n\n";
      
      userSessions.forEach(session => {
        logText += `User: ${session.userName}\n`;
        logText += `Login Time: ${new Date(session.loginTime).toLocaleString()}\n`;
        logText += `Logout Time: ${session.logoutTime ? new Date(session.logoutTime).toLocaleString() : 'Active'}\n`;
        logText += `Duration: ${session.logoutTime ? Math.round((new Date(session.logoutTime) - new Date(session.loginTime)) / 60000) + ' min' : 'Active'}\n`;
        logText += `Search Count: ${session.searchCount || 0}\n`;
        logText += `Last Search: ${session.lastSearch || 'None'}\n`;
        logText += "----------------------------------------\n";
      });
      
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'user_logs.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    // File nickname management
    function updateFileNicknameManager() {
      const manager = document.getElementById('fileNicknameManager');
      manager.innerHTML = '';
      
      availableFiles.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-nickname';
        fileDiv.innerHTML = `
          <label for="nickname-${file.name}">${file.name}:</label>
          <input type="text" id="nickname-${file.name}" value="${fileNicknames[file.name] || file.name}" placeholder="Enter nickname for ${file.name}">
        `;
        manager.appendChild(fileDiv);
      });
    }

    function saveFileNicknames() {
      availableFiles.forEach(file => {
        const nicknameInput = document.getElementById(`nickname-${file.name}`);
        if (nicknameInput) {
          fileNicknames[file.name] = nicknameInput.value.trim() || file.name;
        }
      });
      
      saveUserData();
      updateFileSelect();
      alert("File nicknames saved successfully!");
    }

    function resetFileNicknames() {
      availableFiles.forEach(file => {
        const simpleName = file.name.replace('.xlsx', '').replace('.xls', '').replace('.csv', '').replace(/_/g, ' ');
        fileNicknames[file.name] = simpleName;
      });
      
      saveUserData();
      updateFileSelect();
      updateFileNicknameManager();
      alert("File nicknames reset to default!");
    }

    // Search functionality
    function performSearch() {
      const searchText = document.getElementById('searchInput').value.trim();
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      const selectedColumns = getSelectedColumns();
      
      if (!searchText) {
        alert("Please enter search terms");
        return;
      }
      
      if (excelData.length === 0) {
        alert("No data loaded. Please wait for data to load or select different files.");
        return;
      }
      
      if (selectedColumns.length === 0) {
        alert("Please select at least one column to search in");
        return;
      }
      
      document.getElementById('searchButton').disabled = true;
      
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      
      try {
        const results = [];
        const termMatches = {};
        
        searchTerms.forEach((term, index) => {
          termMatches[term] = 0;
          
          excelData.forEach(item => {
            let matchFound = false;
            
            selectedColumns.forEach(column => {
              if (item[column] !== undefined) {
                const cellValue = String(item[column]).toLowerCase();
                const searchTerm = term.toLowerCase();
                let matches = false;
                
                switch(searchType) {
                  case "contains": 
                    matches = cellValue.includes(searchTerm); 
                    break;
                  case "exact": 
                    matches = cellValue === searchTerm; 
                    break;
                  case "startsWith": 
                    matches = cellValue.startsWith(searchTerm); 
                    break;
                  case "endsWith": 
                    matches = cellValue.endsWith(searchTerm); 
                    break;
                }
                
                if (matches) {
                  matchFound = true;
                  termMatches[term]++;
                }
              }
            });
            
            if (matchFound) {
              const existingIndex = results.findIndex(r => 
                JSON.stringify(r) === JSON.stringify(item)
              );
              
              if (existingIndex === -1) {
                results.push({
                  ...item,
                  highlights: [{ term, color: highlightColors[index % highlightColors.length], columns: selectedColumns }]
                });
              } else {
                results[existingIndex].highlights.push({
                  term,
                  color: highlightColors[index % highlightColors.length],
                  columns: selectedColumns
                });
              }
            }
          });
        });
        
        currentResults = results;
        userSearchCount++;
        userLastSearch = searchText;
        
        const currentSession = userSessions.find(session => 
          session.userName === currentUserName && session.logoutTime === null);
        
        if (currentSession) {
          currentSession.searchCount = userSearchCount;
          currentSession.lastSearch = userLastSearch;
        }
        
        logUserActivity(`${currentUserName} searched for: ${searchText} (${results.length} results)`);
        saveUserData();
        
        displaySearchResults(results, searchTerms, termMatches, selectedColumns);
      } catch (error) {
        console.error('Error during search:', error);
        alert('An error occurred during search. Please try again.');
      } finally {
        document.getElementById('searchButton').disabled = false;
      }
    }

    function displaySearchResults(results, searchTerms, termMatches, searchColumns) {
      const resultsDiv = document.getElementById('results');
      const resultText = document.getElementById('resultText');
      const totalMatches = document.getElementById('totalMatches');
      const perTermMatches = document.getElementById('perTermMatches');
      
      resultsDiv.classList.remove('hidden');
      totalMatches.textContent = results.length;
      
      let perTermText = "Matches per term: ";
      searchTerms.forEach((term, index) => {
        perTermText += `<span class="${highlightColors[index % highlightColors.length]}">${term}</span>: ${termMatches[term]}`;
        if (index < searchTerms.length - 1) perTermText += ", ";
      });
      perTermMatches.innerHTML = perTermText;
      
      if (results.length === 0) {
        resultText.innerHTML = "<p>No results found.</p>";
        document.getElementById('columnVisibilityControls').style.display = 'none';
        document.getElementById('activeFiltersPanel').classList.add('hidden');
        return;
      }
      
      // Get all columns from results
      const columns = [...new Set(results.flatMap(row => Object.keys(row)))].filter(col => 
        !col.startsWith('__') && col !== 'highlights'
      );
      
      // Initialize column visibility and filters
      columns.forEach(col => {
        if (columnVisibility[col] === undefined) columnVisibility[col] = true;
        if (columnFilters[col] === undefined) columnFilters[col] = [];
      });
      
      updateColumnVisibilityControls(columns);
      updateActiveFiltersDisplay();
      
      let tableHTML = `<table id="resultsTable"><thead><tr>`;
      tableHTML += `<th onclick="sortTable('serial')">S/N</th>`;
      tableHTML += `<th onclick="sortTable('__sourceFile')">Source File</th>`;
      
      columns.forEach(col => {
        if (columnVisibility[col]) {
          const isFiltered = columnFilters[col] && columnFilters[col].length > 0;
          const filterClass = isFiltered ? 'filtered-column' : '';
          const filterIndicator = isFiltered ? '<span class="filter-indicator">!</span>' : '';
          
          tableHTML += `
            <th class="${filterClass}" onclick="sortTable('${col}')">
              ${col}${filterIndicator}
              <div class="filter-dropdown">
                <button class="filter-button" onclick="toggleFilterDropdown('${col}', event)">🔍</button>
                <div class="filter-dropdown-content">
                  <input type="text" class="filter-search" placeholder="Search values...">
                  <div class="filter-options"></div>
                  <div class="filter-actions">
                    <button onclick="applyColumnFilter('${col}')" style="background-color: #27ae60;">Apply</button>
                    <button onclick="clearColumnFilter('${col}')" style="background-color: #e74c3c;">Clear</button>
                  </div>
                </div>
              </div>
            </th>
          `;
        }
      });
      
      tableHTML += `</tr></thead><tbody>`;
      
      // Apply column filters to results
      let filteredResults = applyColumnFilters(results);
      
      filteredResults.forEach((result, index) => {
        tableHTML += `<tr class="result-row">`;
        tableHTML += `<td>${index + 1}</td>`;
        tableHTML += `<td>${fileNicknames[result.__sourceFile] || result.__sourceFile}</td>`;
        
        columns.forEach(col => {
          if (columnVisibility[col]) {
            let cellValue = String(result[col] || '');
            
            if (result.highlights) {
              result.highlights.forEach(highlight => {
                if (highlight.columns.includes(col)) {
                  const regex = new RegExp(`(${escapeRegex(highlight.term)})`, 'gi');
                  cellValue = cellValue.replace(regex, `<span class="${highlight.color}">$1</span>`);
                }
              });
            }
            
            tableHTML += `<td>${cellValue}</td>`;
          }
        });
        
        tableHTML += `</tr>`;
      });
      
      tableHTML += `</tbody></table>`;
      resultText.innerHTML = tableHTML;
    }

    // Column visibility functions
    function updateColumnVisibilityControls(columns) {
      const visibilityControls = document.getElementById('columnVisibilityControls');
      const visibilityCheckboxes = document.getElementById('visibilityCheckboxes');
      
      visibilityControls.style.display = 'block';
      visibilityCheckboxes.innerHTML = '';
      
      columns.forEach(col => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'visibility-checkbox';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `vis-${col}`;
        checkbox.checked = columnVisibility[col];
        checkbox.onchange = () => toggleColumnVisibility(col, checkbox.checked);
        
        const label = document.createElement('label');
        label.htmlFor = `vis-${col}`;
        label.textContent = col;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        visibilityCheckboxes.appendChild(checkboxDiv);
      });
    }

    function toggleColumnVisibility(column, isVisible) {
      columnVisibility[column] = isVisible;
      
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      const selectedColumns = getSelectedColumns();
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches, selectedColumns);
    }

    function showAllColumns() {
      Object.keys(columnVisibility).forEach(col => {
        columnVisibility[col] = true;
      });
      
      document.querySelectorAll('.visibility-checkbox input').forEach(checkbox => {
        checkbox.checked = true;
      });
      
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      const selectedColumns = getSelectedColumns();
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches, selectedColumns);
    }

    function hideAllColumns() {
      Object.keys(columnVisibility).forEach(col => {
        columnVisibility[col] = false;
      });
      
      document.querySelectorAll('.visibility-checkbox input').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      const selectedColumns = getSelectedColumns();
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches, selectedColumns);
    }

    // Filter functions
    function toggleFilterDropdown(column, event) {
      event.stopPropagation();
      
      // Close any open dropdown
      if (activeFilterDropdown) {
        activeFilterDropdown.classList.remove('show');
      }
      
      const dropdown = event.target.nextElementSibling;
      
      if (dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
        activeFilterDropdown = null;
      } else {
        dropdown.classList.add('show');
        activeFilterDropdown = dropdown;
        populateFilterOptions(column, dropdown);
        
        // Focus on search input
        setTimeout(() => {
          const searchInput = dropdown.querySelector('.filter-search');
          if (searchInput) searchInput.focus();
        }, 100);
      }
    }

    function populateFilterOptions(column, dropdown) {
      const searchInput = dropdown.querySelector('.filter-search');
      const optionsContainer = dropdown.querySelector('.filter-options');
      
      // Get unique values for this column
      const uniqueValues = [...new Set(currentResults.map(row => String(row[column] || '')))].filter(val => val !== '');
      uniqueValues.sort();
      
      // Get current filter values for this column
      const currentFilters = columnFilters[column] || [];
      
      // Clear existing options
      optionsContainer.innerHTML = '';
      
      // Add search functionality
      searchInput.oninput = function(e) {
        e.stopPropagation();
        const searchTerm = this.value.toLowerCase();
        const filteredValues = uniqueValues.filter(val => val.toLowerCase().includes(searchTerm));
        renderFilterOptions(filteredValues, currentFilters, optionsContainer, column);
      };
      
      // Initial render
      renderFilterOptions(uniqueValues, currentFilters, optionsContainer, column);
    }

    function renderFilterOptions(values, currentFilters, container, column) {
      container.innerHTML = '';
      
      if (values.length === 0) {
        container.innerHTML = '<div style="padding: 5px; font-style: italic; color: #666;">No values found</div>';
        return;
      }
      
      values.forEach(value => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'filter-option';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = value;
        checkbox.checked = currentFilters.includes(value);
        checkbox.onchange = function(e) {
          e.stopPropagation();
          updateColumnFilterSelection(column, value, this.checked);
        };
        
        const label = document.createElement('label');
        label.textContent = value;
        label.style.cursor = 'pointer';
        label.onclick = function(e) {
          e.stopPropagation();
          checkbox.checked = !checkbox.checked;
          updateColumnFilterSelection(column, value, checkbox.checked);
        };
        
        optionDiv.appendChild(checkbox);
        optionDiv.appendChild(label);
        container.appendChild(optionDiv);
      });
    }

    function updateColumnFilterSelection(column, value, isSelected) {
      if (!columnFilters[column]) {
        columnFilters[column] = [];
      }
      
      if (isSelected) {
        if (!columnFilters[column].includes(value)) {
          columnFilters[column].push(value);
        }
      } else {
        columnFilters[column] = columnFilters[column].filter(v => v !== value);
      }
    }

    function applyColumnFilter(column) {
      if (activeFilterDropdown) {
        activeFilterDropdown.classList.remove('show');
        activeFilterDropdown = null;
      }
      
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      const selectedColumns = getSelectedColumns();
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches, selectedColumns);
      updateActiveFiltersDisplay();
    }

    function clearColumnFilter(column) {
      columnFilters[column] = [];
      applyColumnFilter(column);
    }

    function applyColumnFilters(results) {
      let filtered = [...results];
      let hasActiveFilter = false;
      
      // Check if any filter has values
      Object.keys(columnFilters).forEach(column => {
        if (columnFilters[column] && columnFilters[column].length > 0) {
          hasActiveFilter = true;
        }
      });
      
      if (hasActiveFilter) {
        filtered = filtered.filter(row => {
          return Object.keys(columnFilters).every(column => {
            const filterValues = columnFilters[column];
            if (!filterValues || filterValues.length === 0) return true;
            
            const cellValue = String(row[column] || '');
            return filterValues.includes(cellValue);
          });
        });
      }
      
      return filtered;
    }

    function updateActiveFiltersDisplay() {
      const activeFiltersPanel = document.getElementById('activeFiltersPanel');
      const activeFiltersList = document.getElementById('activeFiltersList');
      
      let hasActiveFilters = false;
      Object.keys(columnFilters).forEach(column => {
        if (columnFilters[column] && columnFilters[column].length > 0) {
          hasActiveFilters = true;
        }
      });
      
      if (hasActiveFilters) {
        activeFiltersPanel.classList.remove('hidden');
        activeFiltersList.innerHTML = '';
        
        Object.keys(columnFilters).forEach(column => {
          if (columnFilters[column] && columnFilters[column].length > 0) {
            const filterTag = document.createElement('div');
            filterTag.className = 'active-filter-tag';
            filterTag.innerHTML = `
              ${column}: ${columnFilters[column].length} value(s)
              <span class="remove-filter" onclick="removeColumnFilter('${column}')">×</span>
            `;
            activeFiltersList.appendChild(filterTag);
          }
        });
      } else {
        activeFiltersPanel.classList.add('hidden');
      }
    }

    function clearAllFilters() {
      Object.keys(columnFilters).forEach(column => {
        columnFilters[column] = [];
      });
      
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      const selectedColumns = getSelectedColumns();
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches, selectedColumns);
      updateActiveFiltersDisplay();
    }

    function removeColumnFilter(column) {
      columnFilters[column] = [];
      
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      const selectedColumns = getSelectedColumns();
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches, selectedColumns);
      updateActiveFiltersDisplay();
    }

    // Column selection functions
    function updateColumnCheckboxes() {
      const columnCheckboxes = document.getElementById('columnCheckboxes');
      columnCheckboxes.innerHTML = '';
      
      if (excelData.length === 0) {
        columnCheckboxes.innerHTML = '<p>No data available. Please select files first.</p>';
        return;
      }
      
      availableColumns = [...new Set(excelData.flatMap(row => Object.keys(row)))].filter(col => 
        !col.startsWith('__')
      );
      
      if (availableColumns.length === 0) {
        columnCheckboxes.innerHTML = '<p>No columns found in the data</p>';
        return;
      }
      
      availableColumns.forEach(column => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'column-checkbox';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `col-${column}`;
        checkbox.value = column;
        checkbox.checked = true;
        
        const label = document.createElement('label');
        label.htmlFor = `col-${column}`;
        label.textContent = column;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        columnCheckboxes.appendChild(checkboxDiv);
      });
    }

    function selectAllColumns() {
      document.querySelectorAll('.column-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
      });
    }

    function deselectAllColumns() {
      document.querySelectorAll('.column-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
    }

    function getSelectedColumns() {
      const selectedColumns = [];
      document.querySelectorAll('.column-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
        selectedColumns.push(checkbox.value);
      });
      return selectedColumns;
    }

    // Utility functions
    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      let sortedResults = [...currentResults];
      
      if (column === 'serial') {
        // No sorting needed for serial numbers
      } else {
        sortedResults.sort((a, b) => {
          let aValue = a[column];
          let bValue = b[column];
          
          if (typeof aValue === 'string') {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
          }
          
          if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
          if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
          return 0;
        });
      }
      
      document.querySelectorAll('#resultsTable th').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.textContent.includes(column) || th.getAttribute('onclick')?.includes(column)) {
          th.classList.add(sortDirection);
        }
      });
      
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      const selectedColumns = getSelectedColumns();
      
      searchTerms.forEach(term => {
        termMatches[term] = sortedResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(sortedResults, searchTerms, termMatches, selectedColumns);
    }

    // Customization functions
    function toggleCustomizationPanel() {
      const panel = document.getElementById('customizationPanel');
      panel.classList.toggle('hidden');
    }

    function updateThemeColor(color) {
      customizationSettings.themeColor = color;
    }

    function updateBackgroundColor(color) {
      customizationSettings.backgroundColor = color;
    }

    function updateFontFamily(fontFamily) {
      customizationSettings.fontFamily = fontFamily;
    }

    function updateTableRowHeight(height) {
      customizationSettings.tableRowHeight = height;
    }

    function applyCustomization() {
      document.documentElement.style.setProperty('--button-color', customizationSettings.themeColor);
      document.documentElement.style.setProperty('--header-color', customizationSettings.themeColor);
      
      const hoverColor = shadeColor(customizationSettings.themeColor, -20);
      document.documentElement.style.setProperty('--button-hover-color', hoverColor);
      
      document.documentElement.style.setProperty('--bg-color', `linear-gradient(to right, ${customizationSettings.backgroundColor}, ${shadeColor(customizationSettings.backgroundColor, 10)})`);
      document.documentElement.style.setProperty('--font-family', customizationSettings.fontFamily);
      
      const tableCells = document.querySelectorAll('th, td');
      tableCells.forEach(cell => {
        switch(customizationSettings.tableRowHeight) {
          case 'compact':
            cell.style.padding = '4px 6px';
            cell.style.fontSize = '0.8rem';
            break;
          case 'normal':
            cell.style.padding = '8px';
            cell.style.fontSize = '0.9rem';
            break;
          case 'spacious':
            cell.style.padding = '12px 10px';
            cell.style.fontSize = '1rem';
            break;
        }
      });
      
      saveCustomizationSettings();
      toggleCustomizationPanel();
    }

    function resetCustomization() {
      customizationSettings = {
        themeColor: '#007acc',
        backgroundColor: '#f0f8ff',
        fontFamily: "'Segoe UI', sans-serif",
        tableRowHeight: 'normal'
      };
      
      document.getElementById('themeColor').value = customizationSettings.themeColor;
      document.getElementById('backgroundColor').value = customizationSettings.backgroundColor;
      document.getElementById('fontFamily').value = customizationSettings.fontFamily;
      document.getElementById('tableRowHeight').value = customizationSettings.tableRowHeight;
      
      applyCustomization();
    }

    function saveCustomizationSettings() {
      localStorage.setItem('dashboardCustomization', JSON.stringify(customizationSettings));
    }

    function loadCustomizationSettings() {
      const savedSettings = localStorage.getItem('dashboardCustomization');
      if (savedSettings) {
        customizationSettings = JSON.parse(savedSettings);
        
        document.getElementById('themeColor').value = customizationSettings.themeColor;
        document.getElementById('backgroundColor').value = customizationSettings.backgroundColor;
        document.getElementById('fontFamily').value = customizationSettings.fontFamily;
        document.getElementById('tableRowHeight').value = customizationSettings.tableRowHeight;
        
        applyCustomization();
      }
    }

    function shadeColor(color, percent) {
      let R = parseInt(color.substring(1, 3), 16);
      let G = parseInt(color.substring(3, 5), 16);
      let B = parseInt(color.substring(5, 7), 16);

      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);

      R = R < 255 ? R : 255;
      G = G < 255 ? G : 255;
      B = B < 255 ? B : 255;

      const RR = R.toString(16).length === 1 ? "0" + R.toString(16) : R.toString(16);
      const GG = G.toString(16).length === 1 ? "0" + G.toString(16) : G.toString(16);
      const BB = B.toString(16).length === 1 ? "0" + B.toString(16) : B.toString(16);

      return "#" + RR + GG + BB;
    }

    // Mobile view functions
    function checkMobileDevice() {
      isMobileView = window.innerWidth <= 768;
      updateMobileView();
    }

    function toggleMobileView() {
      isMobileView = !isMobileView;
      updateMobileView();
      document.getElementById('mobileViewToggle').textContent = isMobileView ? "🖥️ Desktop View" : "📱 Mobile View";
    }

    function updateMobileView() {
      if (isMobileView) {
        document.body.classList.add('mobile-view');
      } else {
        document.body.classList.remove('mobile-view');
      }
    }

    // Export functions
    function handleExportClick(type) {
      if (currentResults.length === 0) {
        alert("No data to export. Please perform a search first.");
        return;
      }
      currentExportType = type;
      showExportPreview(type);
    }

    function showExportPreview(type) {
      const modal = document.getElementById('exportModal');
      const previewType = document.getElementById('previewType');
      const previewMessage = document.getElementById('previewMessage');
      const previewTableContainer = document.getElementById('previewTableContainer');
      const confirmExportBtn = document.getElementById('confirmExportBtn');
      
      previewType.textContent = type.toUpperCase();
      previewMessage.textContent = `Preview of data to be exported (${currentResults.length} rows):`;
      
      let previewHTML = `<table border="1" style="border-collapse: collapse; width: 100%;">`;
      const columns = Object.keys(currentResults[0]).filter(col => 
        !col.startsWith('__') && col !== 'highlights' && columnVisibility[col] !== false
      );
      
      previewHTML += `<tr><th style="padding: 6px; background-color: #f0f0f0;">S/N</th><th style="padding: 6px; background-color: #f0f0f0;">Source File</th>`;
      columns.forEach(col => previewHTML += `<th style="padding: 6px; background-color: #f0f0f0;">${col}</th>`);
      previewHTML += `</tr>`;
      
      const previewRows = currentResults.slice(0, 10);
      previewRows.forEach((row, index) => {
        previewHTML += `<tr><td style="padding: 6px;">${index + 1}</td><td style="padding: 6px;">${fileNicknames[row.__sourceFile] || row.__sourceFile}</td>`;
        columns.forEach(col => previewHTML += `<td style="padding: 6px;">${row[col] || ''}</td>`);
        previewHTML += `</tr>`;
      });
      
      previewHTML += `</table>`;
      if (currentResults.length > 10) {
        previewHTML += `<p style="text-align: center; margin-top: 8px;">... and ${currentResults.length - 10} more rows</p>`;
      }
      
      previewTableContainer.innerHTML = previewHTML;
      confirmExportBtn.onclick = function() { 
        executeExport(type); 
        closeExportPreview(); 
      };
      
      modal.style.display = 'block';
    }

    function closeExportPreview() {
      document.getElementById('exportModal').style.display = 'none';
      currentExportType = null;
    }

    function executeExport(type) {
      switch(type) {
        case 'excel': exportToExcel(); break;
        case 'pdf': exportToPDF(); break;
        case 'csv': exportToCSV(); break;
        case 'print': printResults(); break;
      }
    }

    function exportToExcel() {
      const exportData = currentResults.map((row, index) => {
        const { highlights, __sourceFile, __sheetName, ...data } = row;
        const filteredData = {};
        Object.keys(data).forEach(key => { 
          if (columnVisibility[key] !== false) filteredData[key] = data[key]; 
        });
        return { 'S/N': index + 1, 'Source File': fileNicknames[__sourceFile] || __sourceFile, ...filteredData };
      });
      
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Search Results");
      XLSX.writeFile(wb, "search_results.xlsx");
    }

    function exportToPDF() {
      const exportData = currentResults.map((row, index) => {
        const { highlights, __sourceFile, __sheetName, ...data } = row;
        const filteredData = {};
        Object.keys(data).forEach(key => { 
          if (columnVisibility[key] !== false) filteredData[key] = data[key]; 
        });
        return { 'S/N': index + 1, 'Source File': fileNicknames[__sourceFile] || __sourceFile, ...filteredData };
      });
      
      const headers = Object.keys(exportData[0]);
      const body = exportData.map(row => headers.map(header => String(row[header] || '')));
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('Search Results', 14, 15);
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);
      doc.text(`Total records: ${exportData.length}`, 14, 28);
      doc.autoTable({ 
        head: [headers], 
        body: body, 
        startY: 35, 
        styles: { fontSize: 8 }, 
        headStyles: { fillColor: [52, 152, 219] } 
      });
      doc.save('search_results.pdf');
    }

    function exportToCSV() {
      const exportData = currentResults.map((row, index) => {
        const { highlights, __sourceFile, __sheetName, ...data } = row;
        const filteredData = {};
        Object.keys(data).forEach(key => { 
          if (columnVisibility[key] !== false) filteredData[key] = data[key]; 
        });
        return { 'S/N': index + 1, 'Source File': fileNicknames[__sourceFile] || __sourceFile, ...filteredData };
      });
      
      const headers = Object.keys(exportData[0]);
      const csvContent = [
        headers.join(','),
        ...exportData.map(row => headers.map(header => {
          const value = row[header];
          return typeof value === 'string' && (value.includes(',') || value.includes('"')) ? 
            `"${value.replace(/"/g, '""')}"` : value;
        }).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'search_results.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function printResults() {
      const printWindow = window.open('', '_blank');
      const columns = Object.keys(currentResults[0]).filter(col => 
        !col.startsWith('__') && col !== 'highlights' && columnVisibility[col] !== false
      );
      
      let printHTML = `<html><head><title>Search Results</title><style>
        body { font-family: Arial, sans-serif; margin: 15px; } 
        table { border-collapse: collapse; width: 100%; margin-top: 8px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; } 
        th { background-color: #f2f2f2; }
        @media print { body { margin: 0; } table { page-break-inside: auto; } tr { page-break-inside: avoid; page-break-after: auto; } }
      </style></head><body>
        <h1>Search Results</h1>
        <p>Generated: ${new Date().toLocaleString()}</p>
        <p>Total Results: ${currentResults.length}</p>
        <table><thead><tr><th>S/N</th><th>Source File</th>`;
      
      columns.forEach(col => printHTML += `<th>${col}</th>`);
      printHTML += `</tr></thead><tbody>`;
      
      currentResults.forEach((row, index) => {
        printHTML += `<tr><td>${index + 1}</td><td>${fileNicknames[row.__sourceFile] || row.__sourceFile}</td>`;
        columns.forEach(col => printHTML += `<td>${row[col] || ''}</td>`);
        printHTML += `</tr>`;
      });
      
      printHTML += `</tbody></table></body></html>`;
      printWindow.document.write(printHTML);
      printWindow.document.close();
      printWindow.print();
    }

    // Data persistence functions
    function loadUserData() {
      const savedData = localStorage.getItem('excelSearchData');
      if (savedData) {
        const data = JSON.parse(savedData);
        fileNicknames = data.fileNicknames || {};
        searchLogs = data.searchLogs || [];
        userSessions = data.userSessions || [];
      }
    }

    function saveUserData() {
      const data = {
        fileNicknames,
        searchLogs,
        userSessions,
        lastUpdated: new Date().toISOString()
      };
      localStorage.setItem('excelSearchData', JSON.stringify(data));
    }

    function logUserActivity(activity) {
      searchLogs.push({ 
        user: currentUserName || 'Unknown', 
        activity: activity, 
        timestamp: new Date().toISOString() 
      });
      
      if (searchLogs.length > 1000) {
        searchLogs = searchLogs.slice(-1000);
      }
      
      saveUserData();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      if (activeFilterDropdown) {
        activeFilterDropdown.classList.remove('show');
        activeFilterDropdown = null;
      }
    });

    // Close export modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('exportModal');
      if (event.target === modal) {
        closeExportPreview();
      }
    };
  </script>
</body>
</html>