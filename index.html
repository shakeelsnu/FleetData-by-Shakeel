<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Search Dashboard</title>
  <style>
    :root {
      --bg-color: linear-gradient(to right, #f0f8ff, #e6f7ff);
      --text-color: #333;
      --button-color: #007acc;
      --button-hover-color: #005f99;
      --font-family: 'Segoe UI', sans-serif;
      --header-color: #007acc;
      --table-header-bg: #e0f0ff;
      --table-border: #ddd;
      --result-bg: #f9f9f9;
    }
    
    body { 
      font-family: var(--font-family); 
      background: var(--bg-color); 
      color: var(--text-color); 
      padding: 15px; 
      margin: 0;
      transition: all 0.3s ease;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
    }
    h1 { 
      color: var(--header-color); 
      text-shadow: 1px 1px 2px #ccc; 
      margin-bottom: 5px; 
      font-size: 1.8rem;
    }
    .author { 
      color: #888; 
      font-size: 0.9em; 
      margin-top: 0; 
      margin-bottom: 20px; 
    }
    input[type="text"], input[type="password"] { 
      padding: 12px; 
      margin: 10px 0; 
      border: 2px solid var(--button-color); 
      border-radius: 5px; 
      box-sizing: border-box;
      font-size: 16px;
      transition: width 0.3s ease-in-out;
      background: white;
      color: #333;
    }
    #userName {
      width: 150px;
      padding: 8px 12px;
    }
    #userName:focus {
      width: 100%;
    }
    #mainContent h3 {
        font-size: 1.2em;
        margin-bottom: 5px;
    }
    .search-inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-wrap: wrap;
    }
    #searchInput {
      width: 250px;
      padding: 8px 12px;
    }
    #searchInput:focus {
      flex: 1;
      width: 100%;
    }
    select#fileSelect {
      padding: 8px 12px;
      margin: 10px 0;
      border: 2px solid var(--button-color);
      border-radius: 5px;
      font-size: 16px;
      background: white;
      color: #333;
    }
    button { 
      padding: 12px 18px; 
      margin: 8px 5px; 
      border: none; 
      border-radius: 5px; 
      background-color: var(--button-color); 
      color: white; 
      cursor: pointer; 
      box-shadow: 1px 1px 5px #aaa; 
      transition: all 0.3s ease; 
      font-size: 16px;
    }
    button:hover { 
      background-color: var(--button-hover-color); 
      transform: translateY(-2px);
      box-shadow: 2px 4px 8px #999;
    }
    .hidden { 
      display: none; 
    }
    #results, #adminPanel, #adminLogin { 
      margin-top: 20px; 
      background-color: var(--result-bg); 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 0 10px #ccc; 
    }
    table { 
      min-width: 600px;
      border-collapse: collapse; 
      margin-bottom: 10px; 
      width: 100%;
      border: 1px solid var(--table-border);
    }
    th, td { 
      border: 1px solid var(--table-border); 
      padding: 10px; 
      text-align: left; 
      font-size: 0.9rem;
      line-height: 1.3;
      position: relative;
    }
    th { 
      background-color: var(--table-header-bg); 
      font-weight: bold; 
      cursor: pointer; 
      position: relative; 
      white-space: nowrap;
    }
    th:hover { 
      background-color: #c9e5ff; 
    }
    th::after { 
      content: '↕'; 
      position: absolute; 
      right: 8px; 
      top: 50%; 
      transform: translateY(-50%); 
      font-size: 0.8em; 
      opacity: 0.5; 
    }
    th.asc::after { 
      content: '↑'; 
      opacity: 1; 
    }
    th.desc::after { 
      content: '↓'; 
      opacity: 1; 
    }
    .resize-handle {
      display: none;
    }
    #timestamp { 
      margin-top: 30px; 
      font-style: italic; 
      color: #555; 
      font-size: 0.9rem;
    }
    .error { 
      color: red; 
      margin-top: 5px; 
      font-weight: bold;
    }
    /* Improved highlight colors - brighter but text remains visible */
    .highlight-0 { background-color: #FFFF00; font-weight: bold; }  /* Bright Yellow */
    .highlight-1 { background-color: #00FF00; font-weight: bold; }  /* Bright Green */
    .highlight-2 { background-color: #00FFFF; font-weight: bold; }  /* Bright Cyan */
    .highlight-3 { background-color: #FF00FF; font-weight: bold; color: white; }  /* Bright Magenta */
    .highlight-4 { background-color: #FF8000; font-weight: bold; }  /* Bright Orange */
    .highlight-5 { background-color: #FF0080; font-weight: bold; color: white; }  /* Bright Pink */
    .file-selector { 
      margin: 15px 0; 
    }
    .file-selector label { 
      font-weight: bold; 
      display: block; 
      margin-bottom: 5px; 
      font-size: 1.1rem;
    }
    .file-nickname { 
      display: flex; 
      align-items: center; 
      margin-bottom: 10px; 
      flex-wrap: wrap;
    }
    .file-nickname input { 
      margin-right: 10px; 
      flex: 1;
      min-width: 150px;
    }
    .admin-section { 
      margin-top: 20px; 
      padding: 15px; 
      background-color: #f0f8ff; 
      border-radius: 8px; 
    }
    .admin-tools { 
      margin-top: 20px; 
      padding: 15px; 
      background-color: #fff0f0; 
      border-radius: 8px; 
    }
    .password-prompt { 
      margin-top: 15px; 
      padding: 10px; 
      background-color: #fff9e6; 
      border-radius: 5px; 
      border: 1px solid #ffcc00; 
    }
    .admin-header { 
      text-decoration: underline; 
      text-underline-offset: 5px; 
      margin-bottom: 15px; 
      color: #007acc;
      font-size: 1.2rem;
    }
    .selection-controls { 
      margin: 10px 0; 
    }
    .log-row { 
      transition: background-color 0.2s; 
    }
    .log-row:hover { 
      background-color: #f5f5f5; 
    }
    .selected { 
      background-color: #e6f7ff !important; 
    }
    .table-container { 
      position: relative; 
      overflow-x: auto;
      width: 100%;
    }
    #selectAllLogs { 
      margin-right: 10px; 
    }
    .selected-files { 
      margin-top: 10px; 
      font-style: italic; 
      color: #555; 
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    .admin-button {
      background-color: #8e44ad;
    }
    .logout-button {
      background-color: #ff6b6b;
    }
    .search-button {
      background-color: #27ae60;
    }
    .export-button {
      background-color: #9b59b6;
    }
    .export-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .delete-selected-container {
      margin-top: 15px;
      padding: 10px;
      background-color: #fff0f0;
      border-radius: 5px;
      border: 1px solid #ff6b6b;
    }
    
    /* Theme Customization Panel */
    #themePanel {
      position: fixed;
      right: -320px;
      top: 0;
      width: 300px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
    }
    
    #themePanel.open {
      right: 0;
    }
    
    .theme-option {
      margin-bottom: 15px;
    }
    
    .theme-option label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .theme-toggle {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1001;
      background-color: var(--button-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .color-preview {
      width: 30px;
      height: 30px;
      display: inline-block;
      border: 1px solid #ccc;
      vertical-align: middle;
      margin-left: 10px;
      border-radius: 4px;
    }
    
    .preset-themes {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .preset-theme {
      height: 40px;
      border: 1px solid #ddd;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .preset-theme.light {
      background: linear-gradient(to right, #f0f8ff, #e6f7ff);
    }
    
    .preset-theme.dark {
      background: linear-gradient(to right, #2c3e50, #34495e);
    }
    
    .preset-theme.warm {
      background: linear-gradient(to right, #fff8f0, #fff0e6);
    }
    
    .preset-theme.cool {
      background: linear-gradient(to right, #f0f0ff, #e6e6ff);
    }
    
    .preset-theme.nature {
      background: linear-gradient(to right, #f0fff0, #e6ffe6);
    }
    
    .preset-theme.sunset {
      background: linear-gradient(to right, #fff0f0, #ffe6e6);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .search-inputs {
        flex-direction: column;
        gap: 5px;
      }
      
      input[type="text"], input[type="password"], select {
        font-size: 14px;
        padding: 10px;
      }
      
      button {
        width: 100%;
        margin: 5px 0;
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .button-group {
        flex-direction: column;
        gap: 5px;
      }
      
      #results, #adminPanel, #adminLogin {
        padding: 15px;
        margin-top: 15px;
      }
      
      th, td {
        padding: 8px 6px;
        font-size: 0.8rem;
      }
      
      th::after {
        right: 4px;
        font-size: 0.7em;
      }
      
      .admin-header {
        font-size: 1.1rem;
      }
      
      .export-options {
        flex-direction: column;
      }
      
      .resize-handle {
        display: none;
      }
      
      #themePanel {
        width: 85%;
        right: -85%;
      }
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-height: 90%;
        overflow-y: auto;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .modal-actions {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    #previewTableContainer {
        max-height: 500px;
        overflow-y: auto;
    }
    .top-buttons {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    .refresh-button {
      background-color: #3498db;
    }
    
    /* New styles for search options */
    .search-options-panel {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .search-options-header {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .search-type-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .search-type-option {
      display: flex;
      align-items: center;
    }
    
    .search-type-option input {
      margin-right: 5px;
    }
    
    .column-selector {
      margin-top: 15px;
    }
    
    .column-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 5px;
      background-color: white;
    }
    
    .column-checkbox {
      display: flex;
      align-items: center;
    }
    
    .column-checkbox input {
      margin-right: 8px;
    }
    
    .mobile-view-toggle {
      background-color: #9b59b6;
    }
    
    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Column visibility controls */
    .column-visibility-controls {
      background-color: #f0f8ff;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border: 1px solid #cce7ff;
    }
    
    .column-visibility-header {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .visibility-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .visibility-checkbox {
      display: flex;
      align-items: center;
      background: white;
      padding: 5px 10px;
      border-radius: 3px;
      border: 1px solid #ddd;
    }
    
    .visibility-checkbox input {
      margin-right: 5px;
    }
    
    /* Search loading indicator */
    .search-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    
    /* Mobile-specific styles */
    .mobile-view .container {
      padding: 5px;
    }
    
    .mobile-view h1 {
      font-size: 1.3rem;
    }
    
    .mobile-view .search-options-panel {
      padding: 10px;
    }
    
    .mobile-view .search-type-selector {
      flex-direction: column;
    }
    
    .mobile-view .column-checkboxes {
      grid-template-columns: 1fr;
    }
    
    .mobile-view .button-group {
      flex-direction: column;
    }
    
    .mobile-view .export-options {
      flex-direction: column;
    }
    
    .mobile-view .visibility-checkboxes {
      flex-direction: column;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <button onclick="location.reload()" class="refresh-button">🔄 Refresh</button>
      <button onclick="toggleMobileView()" class="mobile-view-toggle" id="mobileViewToggle">📱 Mobile View</button>
    </div>
    <h1>📊 Excel Search Dashboard</h1>
    <p class="author">by Shakeel</p>
    
    <div id="userAuth">
      <h3>Please Enter Your Name to Continue</h3>
      <input type="text" id="userName" placeholder="Enter your name (letters only)..." />
      <div id="nameError" class="error hidden">Please enter a valid name (letters only, no numbers or special characters)</div>
      <div class="button-group">
        <button onclick="setUserName()">Continue</button>
        <button onclick="toggleAdminLogin()" class="admin-button">Admin Mode</button>
      </div>
    </div>
    
    <div id="mainContent" class="hidden">
      <p id="timestamp">Page loaded: <span id="lastUpdated"></span></p>
      
      <div class="export-options">
          <button onclick="handleExportClick('excel')" class="export-button">📊 Export to Excel</button>
          <button onclick="handleExportClick('pdf')" class="export-button">📄 Export to PDF</button>
          <button onclick="handleExportClick('csv')" class="export-button">📝 Export to CSV</button>
          <button onclick="handleExportClick('print')" class="export-button">🖨️ Print</button>
      </div>
      
      <div class="search-inputs">
        <div class="file-selector">
          <label for="fileSelect">📁 Select Files:</label>
          <select id="fileSelect">
            <option value="" selected disabled>-- Loading files from GitHub... --</option>
            <option value="all">All Files</option>
          </select>
        </div>
        
        <!-- Search Options Panel -->
        <div class="search-options-panel">
          <div class="search-options-header">
            <span>🔍 Search Options</span>
          </div>
          
          <div class="search-type-selector">
            <div class="search-type-option">
              <input type="radio" id="searchTypeContains" name="searchType" value="contains" checked>
              <label for="searchTypeContains">Contains</label>
            </div>
            <div class="search-type-option">
              <input type="radio" id="searchTypeExact" name="searchType" value="exact">
              <label for="searchTypeExact">Exact Match</label>
            </div>
            <div class="search-type-option">
              <input type="radio" id="searchTypeStartsWith" name="searchType" value="startsWith">
              <label for="searchTypeStartsWith">Starts With</label>
            </div>
            <div class="search-type-option">
              <input type="radio" id="searchTypeEndsWith" name="searchType" value="endsWith">
              <label for="searchTypeEndsWith">Ends With</label>
            </div>
          </div>
          
          <div class="column-selector">
            <label><strong>🔍 Search in Specific Columns:</strong></label>
            <div class="column-checkboxes" id="columnCheckboxes">
              <p>Select files first to see available columns</p>
            </div>
            <div class="button-group" style="margin-top: 10px;">
              <button onclick="selectAllColumns()">Select All Columns</button>
              <button onclick="deselectAllColumns()">Deselect All Columns</button>
            </div>
          </div>
        </div>
        
        <input type="text" id="searchInput" placeholder="Search keywords separated by commas..." />
      </div>
      
      <div class="button-group">
        <button onclick="performSearch()" class="search-button" id="searchButton">Search</button>
        <button onclick="toggleAdminLogin()" class="admin-button">Admin Mode</button>
        <button onclick="logout()" class="logout-button">Logout</button>
      </div>

      <!-- Search Loading Indicator -->
      <div id="searchLoading" class="search-loading hidden">
        <div class="loading"></div>
      </div>

      <div id="results" class="hidden">
        <p><strong>Excel Sources Loaded:</strong> <span id="excelUploadDate">Fetching...</span></p>
        <p>Total Matches: <span id="totalMatches">0</span></p>
        <p id="perTermMatches"></p>
        
        <!-- Column Visibility Controls -->
        <div class="column-visibility-controls" id="columnVisibilityControls" style="display: none;">
          <div class="column-visibility-header">
            <span>👁️ Show/Hide Columns</span>
            <div class="button-group" style="margin: 0;">
              <button onclick="showAllColumns()" style="padding: 5px 10px; font-size: 12px;">Show All</button>
              <button onclick="hideAllColumns()" style="padding: 5px 10px; font-size: 12px;">Hide All</button>
            </div>
          </div>
          <div class="visibility-checkboxes" id="visibilityCheckboxes">
            <!-- Column visibility checkboxes will be populated here -->
          </div>
        </div>
        
        <h3>🔎 Search Results</h3>
        
        <div class="table-container">
          <div id="resultText"></div>
        </div>
      </div>
    </div>

    <div id="adminLogin" class="hidden">
      <h3>🔐 Admin Login</h3>
      <input type="text" id="adminUser" placeholder="Username" />
      <input type="password" id="adminPass" placeholder="Password" />
      <div class="button-group">
        <button onclick="checkAdminLogin()">Login</button>
        <button onclick="toggleAdminLogin()" class="logout-button">Cancel</button>
      </div>
    </div>

    <div id="adminPanel" class="hidden">
      <h3 class="admin-header">📋 Admin Panel - User Activity Logs</h3>
      <button onclick="hideAdminPanel()" class="logout-button" style="margin-bottom: 15px;">Close Admin Panel</button>
      
      <div class="admin-tools">
        <h3 class="admin-header">🛠️ Admin Tools</h3>
        <div class="button-group">
          <button onclick="exportUserLogs()">📝 Export Logs as Text</button>
          <button onclick="showDeleteConfirmation()" class="logout-button">🗑️ Delete All Logs</button>
        </div>
        
        <div class="selection-controls">
          <label><input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs(this.checked)"> Select All</label>
        </div>
        
        <div id="deleteSelectedContainer" class="delete-selected-container hidden">
          <p><strong><span id="selectedCount">0</span> log(s) selected</strong></p>
          <button onclick="deleteSelectedLogs()" class="logout-button">🗑️ Delete Selected</button>
        </div>
        
        <div id="deleteConfirmation" class="password-prompt hidden">
          <h4>Confirm Deletion</h4>
          <p>This will permanently delete all selected user logs. This action cannot be undone.</p>
          <input type="password" id="deletePassword" placeholder="Enter admin password to confirm" />
          <div class="button-group">
            <button onclick="deleteAllLogs()" class="logout-button">Confirm Delete All</button>
            <button onclick="hideDeleteConfirmation()">Cancel</button>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table id="adminLogsTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>User Name</th>
              <th>Login Time</th>
              <th>Logout Time</th>
              <th>Duration</th>
              <th>Search Count</th>
              <th>Last Search</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>

      <div class="admin-section">
        <h3 class="admin-header">📁 File Management - Set Nicknames</h3>
        <div id="fileNicknameManager">
          </div>
        <div class="button-group">
          <button onclick="saveFileNicknames()">💾 Save Nicknames</button>
          <button onclick="resetFileNicknames()" class="logout-button">🔄 Reset to Default</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Theme Panel -->
  <div id="themePanel">
    <h3>🎨 Customize Theme</h3>
    
    <div class="theme-option">
      <label for="bgColor">Background Color 1:</label>
      <input type="color" id="bgColor" value="#f0f8ff">
      <span class="color-preview" id="bgPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="bgColor2">Background Color 2:</label>
      <input type="color" id="bgColor2" value="#e6f7ff">
      <span class="color-preview" id="bgPreview2"></span>
    </div>
    
    <div class="theme-option">
      <label for="textColor">Text Color:</label>
      <input type="color" id="textColor" value="#333333">
      <span class="color-preview" id="textPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="buttonColor">Button Color:</label>
      <input type="color" id="buttonColor" value="#007acc">
      <span class="color-preview" id="buttonPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="headerColor">Header Color:</label>
      <input type="color" id="headerColor" value="#007acc">
      <span class="color-preview" id="headerPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="fontFamily">Font Family:</label>
      <select id="fontFamily">
        <option value="'Segoe UI', sans-serif">Segoe UI</option>
        <option value="Arial, sans-serif">Arial</option>
        <option value="'Times New Roman', serif">Times New Roman</option>
        <option value="'Courier New', monospace">Courier New</option>
        <option value="Georgia, serif">Georgia</option>
        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
        <option value="Verdana, sans-serif">Verdana</option>
      </select>
    </div>
    
    <h4>Preset Themes:</h4>
    <div class="preset-themes">
      <div class="preset-theme light" onclick="applyPreset('light')" title="Light Theme"></div>
      <div class="preset-theme dark" onclick="applyPreset('dark')" title="Dark Theme"></div>
      <div class="preset-theme warm" onclick="applyPreset('warm')" title="Warm Theme"></div>
      <div class="preset-theme cool" onclick="applyPreset('cool')" title="Cool Theme"></div>
      <div class="preset-theme nature" onclick="applyPreset('nature')" title="Nature Theme"></div>
      <div class="preset-theme sunset" onclick="applyPreset('sunset')" title="Sunset Theme"></div>
    </div>
    
    <div class="button-group" style="margin-top: 20px;">
      <button onclick="saveTheme()">💾 Save Theme</button>
      <button onclick="resetTheme()" class="logout-button">🔄 Reset to Default</button>
      <button onclick="toggleThemePanel()" class="logout-button">Close</button>
    </div>
  </div>
  
  <button class="theme-toggle" onclick="toggleThemePanel()">🎨</button>

  <!-- Export Preview Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeExportPreview()">&times;</span>
      <h3>Export Preview (<span id="previewType"></span>)</h3>
      <p id="previewMessage"></p>
      <div id="previewTableContainer"></div>
      <div class="modal-actions">
        <button onclick="closeExportPreview()">Cancel</button>
        <button id="confirmExportBtn">Confirm Export</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Global variables
    let excelData = [];
    let availableFiles = [];
    let fileNicknames = {};
    let searchLogs = [];
    let userSessions = [];
    let currentResults = [];
    let currentUserName = "";
    let currentUserLoginTime = null;
    let userSearchCount = 0;
    let userLastSearch = "";
    const highlightColors = ["highlight-0", "highlight-1", "highlight-2", "highlight-3", "highlight-4", "highlight-5"];
    let sortColumn = null;
    let sortDirection = 'asc';
    let selectedLogs = new Set();
    let isResizing = false;
    let currentResizeHeader = null;
    let startX = 0;
    let startWidth = 0;
    let currentExportType = null;
    let availableColumns = [];
    let isMobileView = false;
    const GITHUB_REPO_URL = "https://api.github.com/repos/shakeelsnu/FleetData-by-Shakeel/contents/";
    const GITHUB_RAW_URL = "https://raw.githubusercontent.com/shakeelsnu/FleetData-by-Shakeel/main/";
    let columnVisibility = {}; // Track column visibility state

    // Theme customization functions
    function toggleThemePanel() {
      document.getElementById('themePanel').classList.toggle('open');
    }
    
    function loadTheme() {
      const savedTheme = localStorage.getItem('userTheme');
      if (savedTheme) {
        const theme = JSON.parse(savedTheme);
        applyTheme(theme);
        
        // Set form values to match current theme
        document.getElementById('bgColor').value = theme.bgColor;
        document.getElementById('bgColor2').value = theme.bgColor2;
        document.getElementById('textColor').value = theme.textColor;
        document.getElementById('buttonColor').value = theme.buttonColor;
        document.getElementById('headerColor').value = theme.headerColor;
        document.getElementById('fontFamily').value = theme.fontFamily;
        
        updateColorPreviews();
      }
    }
    
    function applyTheme(theme) {
      document.documentElement.style.setProperty('--bg-color', `linear-gradient(to right, ${theme.bgColor}, ${theme.bgColor2})`);
      document.documentElement.style.setProperty('--text-color', theme.textColor);
      document.documentElement.style.setProperty('--button-color', theme.buttonColor);
      document.documentElement.style.setProperty('--button-hover-color', adjustColor(theme.buttonColor, -30));
      document.documentElement.style.setProperty('--header-color', theme.headerColor);
      document.documentElement.style.setProperty('--font-family', theme.fontFamily);
    }
    
    function saveTheme() {
      const theme = {
        bgColor: document.getElementById('bgColor').value,
        bgColor2: document.getElementById('bgColor2').value,
        textColor: document.getElementById('textColor').value,
        buttonColor: document.getElementById('buttonColor').value,
        headerColor: document.getElementById('headerColor').value,
        fontFamily: document.getElementById('fontFamily').value
      };
      
      localStorage.setItem('userTheme', JSON.stringify(theme));
      applyTheme(theme);
      alert("Theme saved successfully!");
    }
    
    function resetTheme() {
      const defaultTheme = {
        bgColor: "#f0f8ff",
        bgColor2: "#e6f7ff",
        textColor: "#333333",
        buttonColor: "#007acc",
        headerColor: "#007acc",
        fontFamily: "'Segoe UI', sans-serif"
      };
      
      localStorage.removeItem('userTheme');
      applyTheme(defaultTheme);
      
      // Reset form values
      document.getElementById('bgColor').value = defaultTheme.bgColor;
      document.getElementById('bgColor2').value = defaultTheme.bgColor2;
      document.getElementById('textColor').value = defaultTheme.textColor;
      document.getElementById('buttonColor').value = defaultTheme.buttonColor;
      document.getElementById('headerColor').value = defaultTheme.headerColor;
      document.getElementById('fontFamily').value = defaultTheme.fontFamily;
      
      updateColorPreviews();
      
      alert("Theme reset to default!");
    }
    
    function applyPreset(presetName) {
      const presets = {
        light: {
          bgColor: "#f0f8ff",
          bgColor2: "#e6f7ff",
          textColor: "#333333",
          buttonColor: "#007acc",
          headerColor: "#007acc",
          fontFamily: "'Segoe UI', sans-serif"
        },
        dark: {
          bgColor: "#2c3e50",
          bgColor2: "#34495e",
          textColor: "#ecf0f1",
          buttonColor: "#3498db",
          headerColor: "#3498db",
          fontFamily: "Arial, sans-serif"
        },
        warm: {
          bgColor: "#fff8f0",
          bgColor2: "#fff0e6",
          textColor: "#333333",
          buttonColor: "#e67e22",
          headerColor: "#e67e22",
          fontFamily: "Georgia, serif"
        },
        cool: {
          bgColor: "#f0f0ff",
          bgColor2: "#e6e6ff",
          textColor: "#333366",
          buttonColor: "#2980b9",
          headerColor: "#2980b9",
          fontFamily: "'Courier New', monospace"
        },
        nature: {
          bgColor: "#f0fff0",
          bgColor2: "#e6ffe6",
          textColor: "#003300",
          buttonColor: "#27ae60",
          headerColor: "#27ae60",
          fontFamily: "Arial, sans-serif"
        },
        sunset: {
          bgColor: "#fff0f0",
          bgColor2: "#ffe6e6",
          textColor: "#660000",
          buttonColor: "#e74c3c",
          headerColor: "#e74c3c",
          fontFamily: "'Times New Roman', serif"
        }
      };
      
      if (presets[presetName]) {
        applyTheme(presets[presetName]);
        
        // Update form values
        document.getElementById('bgColor').value = presets[presetName].bgColor;
        document.getElementById('bgColor2').value = presets[presetName].bgColor2;
        document.getElementById('textColor').value = presets[presetName].textColor;
        document.getElementById('buttonColor').value = presets[presetName].buttonColor;
        document.getElementById('headerColor').value = presets[presetName].headerColor;
        document.getElementById('fontFamily').value = presets[presetName].fontFamily;
        
        updateColorPreviews();
      }
    }
    
    function updateColorPreviews() {
      document.getElementById('bgPreview').style.backgroundColor = document.getElementById('bgColor').value;
      document.getElementById('bgPreview2').style.backgroundColor = document.getElementById('bgColor2').value;
      document.getElementById('textPreview').style.backgroundColor = document.getElementById('textColor').value;
      document.getElementById('buttonPreview').style.backgroundColor = document.getElementById('buttonColor').value;
      document.getElementById('headerPreview').style.backgroundColor = document.getElementById('headerColor').value;
    }
    
    function adjustColor(color, amount) {
      let usePound = false;
      if (color[0] === "#") {
        color = color.slice(1);
        usePound = true;
      }
      
      let num = parseInt(color, 16);
      let r = (num >> 16) + amount;
      if (r > 255) r = 255;
      else if (r < 0) r = 0;
      
      let b = ((num >> 8) & 0x00FF) + amount;
      if (b > 255) b = 255;
      else if (b < 0) b = 0;
      
      let g = (num & 0x0000FF) + amount;
      if (g > 255) g = 255;
      else if (g < 0) g = 0;
      
      return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
    }
    
    // GitHub data loading functions
    async function loadFilesFromGitHub() {
      try {
        document.getElementById('fileSelect').innerHTML = '<option value="" selected disabled>-- Loading files from GitHub... --</option>';
        
        const response = await fetch(GITHUB_REPO_URL);
        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }
        
        const files = await response.json();
        
        // Filter for Excel files
        const excelFiles = files.filter(file => 
          file.name.toLowerCase().endsWith('.xlsx') || 
          file.name.toLowerCase().endsWith('.xls')
        );
        
        if (excelFiles.length === 0) {
          throw new Error('No Excel files found in the repository');
        }
        
        availableFiles = excelFiles;
        
        // Set default nicknames
        availableFiles.forEach(file => {
          const simpleName = file.name.replace('.xlsx', '').replace('.xls', '').replace(/_/g, ' ');
          fileNicknames[file.name] = simpleName;
        });
        
        // Update file select dropdown
        updateFileSelect();
        
        // Load data from the first file by default
        if (availableFiles.length > 0) {
          await loadExcelDataFromGitHub(availableFiles[0].name);
        }
        
        return excelFiles;
      } catch (error) {
        console.error('Error loading files from GitHub:', error);
        document.getElementById('fileSelect').innerHTML = '<option value="" selected disabled>-- Error loading files --</option>';
        document.getElementById('excelUploadDate').textContent = 'Error loading data from GitHub';
        return [];
      }
    }
    
    async function loadExcelDataFromGitHub(filename) {
      try {
        document.getElementById('excelUploadDate').innerHTML = '<span class="loading"></span> Loading data...';
        
        const rawUrl = `${GITHUB_RAW_URL}${filename}`;
        const response = await fetch(rawUrl);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch file: ${response.status}`);
        }
        
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        // Clear existing data
        excelData = [];
        
        // Process each worksheet
        workbook.SheetNames.forEach(sheetName => {
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          if (jsonData.length > 0) {
            // Extract headers (first row)
            const headers = jsonData[0];
            
            // Process data rows (skip header row)
            for (let i = 1; i < jsonData.length; i++) {
              const rowData = {};
              const row = jsonData[i];
              
              // Map each cell to its header
              headers.forEach((header, index) => {
                if (header && row[index] !== undefined) {
                  rowData[header] = row[index];
                }
              });
              
              // Add file source information
              if (Object.keys(rowData).length > 0) {
                rowData.__sourceFile = filename;
                rowData.__sheetName = sheetName;
                excelData.push(rowData);
              }
            }
          }
        });
        
        document.getElementById('excelUploadDate').textContent = `Loaded ${excelData.length} records from ${filename} at ${new Date().toLocaleString()}`;
        
        // Update column checkboxes
        updateColumnCheckboxes();
        
        return excelData;
      } catch (error) {
        console.error('Error loading Excel data:', error);
        document.getElementById('excelUploadDate').textContent = `Error loading data from ${filename}`;
        return [];
      }
    }
    
    async function loadAllExcelDataFromGitHub() {
      try {
        document.getElementById('excelUploadDate').innerHTML = '<span class="loading"></span> Loading all files...';
        
        // Clear existing data
        excelData = [];
        
        // Load data from each file
        for (const file of availableFiles) {
          const rawUrl = `${GITHUB_RAW_URL}${file.name}`;
          const response = await fetch(rawUrl);
          
          if (response.ok) {
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            // Process each worksheet
            workbook.SheetNames.forEach(sheetName => {
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
              
              if (jsonData.length > 0) {
                // Extract headers (first row)
                const headers = jsonData[0];
                
                // Process data rows (skip header row)
                for (let i = 1; i < jsonData.length; i++) {
                  const rowData = {};
                  const row = jsonData[i];
                  
                  // Map each cell to its header
                  headers.forEach((header, index) => {
                    if (header && row[index] !== undefined) {
                      rowData[header] = row[index];
                    }
                  });
                  
                  // Add file source information
                  if (Object.keys(rowData).length > 0) {
                    rowData.__sourceFile = file.name;
                    rowData.__sheetName = sheetName;
                    excelData.push(rowData);
                  }
                }
              }
            });
          }
        }
        
        document.getElementById('excelUploadDate').textContent = `Loaded ${excelData.length} records from ${availableFiles.length} files at ${new Date().toLocaleString()}`;
        
        // Update column checkboxes
        updateColumnCheckboxes();
        
        return excelData;
      } catch (error) {
        console.error('Error loading all Excel data:', error);
        document.getElementById('excelUploadDate').textContent = 'Error loading data from GitHub';
        return [];
      }
    }
    
    // User authentication functions
    function setUserName() {
      const nameInput = document.getElementById('userName');
      const nameError = document.getElementById('nameError');
      const name = nameInput.value.trim();
      
      // Validate name (letters only, no numbers or special characters)
      if (!name || !/^[a-zA-Z\s]+$/.test(name)) {
        nameError.classList.remove('hidden');
        return;
      }
      
      nameError.classList.add('hidden');
      currentUserName = name;
      currentUserLoginTime = new Date();
      
      // Create user session
      userSessions.push({
        userName: currentUserName,
        loginTime: currentUserLoginTime,
        logoutTime: null,
        searchCount: 0,
        lastSearch: ""
      });
      
      // Save to localStorage
      saveUserData();
      
      // Update UI
      document.getElementById('userAuth').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      // Log user activity
      logUserActivity(`${currentUserName} logged in`);
    }
    
    function logout() {
      // Update user session with logout time
      const currentSession = userSessions.find(session => 
        session.userName === currentUserName && session.logoutTime === null);
      
      if (currentSession) {
        currentSession.logoutTime = new Date();
        currentSession.duration = Math.round((currentSession.logoutTime - currentSession.loginTime) / 1000);
      }
      
      // Save to localStorage
      saveUserData();
      
      // Log user activity
      logUserActivity(`${currentUserName} logged out`);
      
      // Reset UI
      currentUserName = "";
      currentUserLoginTime = null;
      userSearchCount = 0;
      userLastSearch = "";
      
      document.getElementById('userAuth').classList.remove('hidden');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('results').classList.add('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminLogin').classList.add('hidden');
      
      // Clear search input
      document.getElementById('searchInput').value = "";
    }
    
    function toggleAdminLogin() {
      const adminLogin = document.getElementById('adminLogin');
      const mainContent = document.getElementById('mainContent');
      
      if (adminLogin.classList.contains('hidden')) {
        adminLogin.classList.remove('hidden');
        mainContent.classList.add('hidden');
      } else {
        adminLogin.classList.add('hidden');
        mainContent.classList.remove('hidden');
      }
    }
    
    function checkAdminLogin() {
      const username = document.getElementById('adminUser').value;
      const password = document.getElementById('adminPass').value;
      
      // Simple admin authentication
      if (username === 'admin' && password === 'admin123') {
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
        
        // Load admin data
        loadAdminData();
        
        // Log admin activity
        logUserActivity("Admin logged in");
      } else {
        alert("Invalid admin credentials!");
      }
    }
    
    function hideAdminPanel() {
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      // Clear admin login fields
      document.getElementById('adminUser').value = "";
      document.getElementById('adminPass').value = "";
      
      // Log admin activity
      logUserActivity("Admin logged out");
    }
    
    // Data loading and management functions
    function loadUserData() {
      const savedData = localStorage.getItem('excelSearchData');
      if (savedData) {
        const data = JSON.parse(savedData);
        fileNicknames = data.fileNicknames || {};
        searchLogs = data.searchLogs || [];
        userSessions = data.userSessions || [];
      }
    }
    
    function saveUserData() {
      const data = {
        fileNicknames,
        searchLogs,
        userSessions,
        lastUpdated: new Date().toISOString()
      };
      
      localStorage.setItem('excelSearchData', JSON.stringify(data));
    }
    
    function updateFileSelect() {
      const fileSelect = document.getElementById('fileSelect');
      
      // Clear existing options except the first one
      fileSelect.innerHTML = '<option value="" selected disabled>-- Select files to search --</option><option value="all">All Files</option>';
      
      // Add file options
      availableFiles.forEach(file => {
        const option = document.createElement('option');
        option.value = file.name;
        option.textContent = fileNicknames[file.name] || file.name;
        fileSelect.appendChild(option);
      });
      
      // Add event listener for file selection change
      fileSelect.addEventListener('change', async function() {
        const selectedValue = this.value;
        
        if (selectedValue === 'all') {
          await loadAllExcelDataFromGitHub();
        } else if (selectedValue) {
          await loadExcelDataFromGitHub(selectedValue);
        }
        
        // Update column checkboxes
        updateColumnCheckboxes();
      });
    }
    
    function updateColumnCheckboxes() {
      const columnCheckboxes = document.getElementById('columnCheckboxes');
      columnCheckboxes.innerHTML = '';
      
      if (excelData.length === 0) {
        columnCheckboxes.innerHTML = '<p>No data available. Please select files first.</p>';
        return;
      }
      
      // Get all column names from the data (excluding internal columns)
      availableColumns = [...new Set(excelData.flatMap(row => Object.keys(row)))].filter(col => 
        !col.startsWith('__') // Filter out internal columns like __sourceFile, __sheetName
      );
      
      if (availableColumns.length === 0) {
        columnCheckboxes.innerHTML = '<p>No columns found in the data</p>';
        return;
      }
      
      // Create checkboxes for each column
      availableColumns.forEach(column => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'column-checkbox';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `col-${column}`;
        checkbox.value = column;
        checkbox.checked = true; // Default to checked
        
        const label = document.createElement('label');
        label.htmlFor = `col-${column}`;
        label.textContent = column;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        columnCheckboxes.appendChild(checkboxDiv);
      });
    }
    
    function selectAllColumns() {
      document.querySelectorAll('.column-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
      });
    }
    
    function deselectAllColumns() {
      document.querySelectorAll('.column-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
    }
    
    function getSelectedColumns() {
      const selectedColumns = [];
      document.querySelectorAll('.column-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
        selectedColumns.push(checkbox.value);
      });
      return selectedColumns;
    }
    
    // Search functionality
    async function performSearch() {
      const searchText = document.getElementById('searchInput').value.trim();
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      const selectedColumns = getSelectedColumns();
      
      if (!searchText) {
        alert("Please enter search terms");
        return;
      }
      
      if (excelData.length === 0) {
        alert("No data loaded. Please wait for data to load or select different files.");
        return;
      }
      
      if (selectedColumns.length === 0) {
        alert("Please select at least one column to search in");
        return;
      }
      
      // Show loading indicator
      document.getElementById('searchLoading').classList.remove('hidden');
      document.getElementById('searchButton').disabled = true;
      
      // Split search terms by commas and trim each term
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      
      if (searchTerms.length === 0) {
        alert("Please enter valid search terms");
        document.getElementById('searchLoading').classList.add('hidden');
        document.getElementById('searchButton').disabled = false;
        return;
      }
      
      // Use setTimeout to allow UI to update with loading indicator
      setTimeout(async () => {
        try {
          // Apply search based on search type and selected columns
          const results = [];
          const termMatches = {};
          
          searchTerms.forEach((term, index) => {
            termMatches[term] = 0;
            
            excelData.forEach(item => {
              let matchFound = false;
              
              // Check each selected column for a match
              selectedColumns.forEach(column => {
                if (item[column] !== undefined) {
                  const cellValue = String(item[column]).toLowerCase();
                  const searchTerm = term.toLowerCase();
                  
                  let matches = false;
                  
                  switch(searchType) {
                    case "contains":
                      matches = cellValue.includes(searchTerm);
                      break;
                    case "exact":
                      matches = cellValue === searchTerm;
                      break;
                    case "startsWith":
                      matches = cellValue.startsWith(searchTerm);
                      break;
                    case "endsWith":
                      matches = cellValue.endsWith(searchTerm);
                      break;
                  }
                  
                  if (matches) {
                    matchFound = true;
                    termMatches[term]++;
                  }
                }
              });
              
              if (matchFound) {
                // Check if this item is already in results
                const existingIndex = results.findIndex(r => 
                  JSON.stringify(r) === JSON.stringify(item)
                );
                
                if (existingIndex === -1) {
                  // Add to results with highlight info
                  results.push({
                    ...item,
                    highlights: [{ term, color: highlightColors[index % highlightColors.length] }]
                  });
                } else {
                  // Add highlight info to existing result
                  results[existingIndex].highlights.push({
                    term,
                    color: highlightColors[index % highlightColors.length]
                  });
                }
              }
            });
          });
          
          // Remove duplicates (in case multiple terms match the same row)
          currentResults = results;
          
          // Update search count for user
          userSearchCount++;
          userLastSearch = searchText;
          
          // Update current user session
          const currentSession = userSessions.find(session => 
            session.userName === currentUserName && session.logoutTime === null);
          
          if (currentSession) {
            currentSession.searchCount = userSearchCount;
            currentSession.lastSearch = userLastSearch;
          }
          
          // Log the search activity
          logUserActivity(`${currentUserName} searched for: ${searchText} (${results.length} results)`);
          
          // Save user data
          saveUserData();
          
          // Display results
          displaySearchResults(results, searchTerms, termMatches);
        } catch (error) {
          console.error('Error during search:', error);
          alert('An error occurred during search. Please try again.');
        } finally {
          // Hide loading indicator
          document.getElementById('searchLoading').classList.add('hidden');
          document.getElementById('searchButton').disabled = false;
        }
      }, 100);
    }
    
    function displaySearchResults(results, searchTerms, termMatches) {
      const resultsDiv = document.getElementById('results');
      const resultText = document.getElementById('resultText');
      const totalMatches = document.getElementById('totalMatches');
      const perTermMatches = document.getElementById('perTermMatches');
      
      // Show results section
      resultsDiv.classList.remove('hidden');
      
      // Update match counts
      totalMatches.textContent = results.length;
      
      let perTermText = "Matches per term: ";
      searchTerms.forEach((term, index) => {
        perTermText += `<span class="${highlightColors[index % highlightColors.length]}">${term}</span>: ${termMatches[term]}`;
        if (index < searchTerms.length - 1) {
          perTermText += ", ";
        }
      });
      perTermMatches.innerHTML = perTermText;
      
      // Create table for results
      if (results.length === 0) {
        resultText.innerHTML = "<p>No results found.</p>";
        document.getElementById('columnVisibilityControls').style.display = 'none';
        return;
      }
      
      // Get all column names from the first result (excluding internal columns and highlights)
      const columns = Object.keys(results[0]).filter(col => 
        !col.startsWith('__') && col !== 'highlights'
      );
      
      // Initialize column visibility (all visible by default)
      columns.forEach(col => {
        if (columnVisibility[col] === undefined) {
          columnVisibility[col] = true;
        }
      });
      
      // Update column visibility controls
      updateColumnVisibilityControls(columns);
      
      let tableHTML = `<table id="resultsTable">
        <thead>
          <tr>
            <th>Source File</th>
            <th>Sheet Name</th>`;
      
      columns.forEach(col => {
        if (columnVisibility[col]) {
          tableHTML += `<th onclick="sortTable('${col}')">${col}</th>`;
        }
      });
      
      tableHTML += `</tr>
        </thead>
        <tbody>`;
      
      results.forEach((result, index) => {
        tableHTML += `<tr class="result-row">`;
        tableHTML += `<td>${fileNicknames[result.__sourceFile] || result.__sourceFile}</td>`;
        tableHTML += `<td>${result.__sheetName || 'N/A'}</td>`;
        
        columns.forEach(col => {
          if (columnVisibility[col]) {
            let cellValue = String(result[col] || '');
            
            // Apply highlights if this cell contains any search terms
            if (result.highlights) {
              result.highlights.forEach(highlight => {
                const regex = new RegExp(`(${escapeRegex(highlight.term)})`, 'gi');
                cellValue = cellValue.replace(regex, `<span class="${highlight.color}">$1</span>`);
              });
            }
            
            tableHTML += `<td>${cellValue}</td>`;
          }
        });
        
        tableHTML += `</tr>`;
      });
      
      tableHTML += `</tbody></table>`;
      
      resultText.innerHTML = tableHTML;
    }
    
    function updateColumnVisibilityControls(columns) {
      const visibilityControls = document.getElementById('columnVisibilityControls');
      const visibilityCheckboxes = document.getElementById('visibilityCheckboxes');
      
      visibilityControls.style.display = 'block';
      visibilityCheckboxes.innerHTML = '';
      
      columns.forEach(col => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'visibility-checkbox';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `vis-${col}`;
        checkbox.checked = columnVisibility[col];
        checkbox.onchange = () => toggleColumnVisibility(col, checkbox.checked);
        
        const label = document.createElement('label');
        label.htmlFor = `vis-${col}`;
        label.textContent = col;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        visibilityCheckboxes.appendChild(checkboxDiv);
      });
    }
    
    function toggleColumnVisibility(column, isVisible) {
      columnVisibility[column] = isVisible;
      
      // Refresh the results table
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches);
    }
    
    function showAllColumns() {
      Object.keys(columnVisibility).forEach(col => {
        columnVisibility[col] = true;
      });
      
      // Update checkboxes
      document.querySelectorAll('.visibility-checkbox input').forEach(checkbox => {
        checkbox.checked = true;
      });
      
      // Refresh the results table
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches);
    }
    
    function hideAllColumns() {
      Object.keys(columnVisibility).forEach(col => {
        columnVisibility[col] = false;
      });
      
      // Update checkboxes
      document.querySelectorAll('.visibility-checkbox input').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Refresh the results table
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches);
    }
    
    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    function sortTable(column) {
      if (sortColumn === column) {
        // Toggle direction if same column
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        // New column, default to ascending
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      // Sort the current results
      currentResults.sort((a, b) => {
        let aValue = a[column];
        let bValue = b[column];
        
        // Handle different data types
        if (typeof aValue === 'string') {
          aValue = aValue.toLowerCase();
          bValue = bValue.toLowerCase();
        }
        
        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      // Update the table headers to show sort direction
      document.querySelectorAll('#resultsTable th').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.textContent === column || th.getAttribute('onclick')?.includes(column)) {
          th.classList.add(sortDirection);
        }
      });
      
      // Redisplay the results
      const searchText = document.getElementById('searchInput').value.trim();
      const searchTerms = searchText.split(',').map(term => term.trim()).filter(term => term.length > 0);
      const termMatches = {};
      
      searchTerms.forEach(term => {
        termMatches[term] = currentResults.filter(result => 
          result.highlights.some(h => h.term === term)
        ).length;
      });
      
      displaySearchResults(currentResults, searchTerms, termMatches);
    }
    
    // Admin functions
    function loadAdminData() {
      // Update admin logs table
      updateAdminLogsTable();
      
      // Update file nickname manager
      updateFileNicknameManager();
    }
    
    function updateAdminLogsTable() {
      const logTable = document.getElementById('logTable');
      logTable.innerHTML = '';
      
      userSessions.forEach((session, index) => {
        const row = document.createElement('tr');
        row.className = 'log-row';
        
        // Calculate duration if logout time exists
        let duration = 'Active';
        if (session.logoutTime) {
          const diffMs = new Date(session.logoutTime) - new Date(session.loginTime);
          const diffMins = Math.round(diffMs / 60000);
          duration = `${diffMins} min`;
        }
        
        row.innerHTML = `
          <td><input type="checkbox" class="log-checkbox" onchange="toggleLogSelection(${index}, this.checked)"></td>
          <td>${session.userName}</td>
          <td>${new Date(session.loginTime).toLocaleString()}</td>
          <td>${session.logoutTime ? new Date(session.logoutTime).toLocaleString() : 'Active'}</td>
          <td>${duration}</td>
          <td>${session.searchCount || 0}</td>
          <td>${session.lastSearch || 'None'}</td>
        `;
        
        logTable.appendChild(row);
      });
    }
    
    function toggleLogSelection(index, checked) {
      if (checked) {
        selectedLogs.add(index);
      } else {
        selectedLogs.delete(index);
      }
      
      updateSelectedLogsDisplay();
    }
    
    function toggleSelectAllLogs(checked) {
      const checkboxes = document.querySelectorAll('.log-checkbox');
      selectedLogs.clear();
      
      checkboxes.forEach((checkbox, index) => {
        checkbox.checked = checked;
        if (checked) {
          selectedLogs.add(index);
        }
      });
      
      updateSelectedLogsDisplay();
    }
    
    function updateSelectedLogsDisplay() {
      const selectedCount = document.getElementById('selectedCount');
      const deleteSelectedContainer = document.getElementById('deleteSelectedContainer');
      
      selectedCount.textContent = selectedLogs.size;
      
      if (selectedLogs.size > 0) {
        deleteSelectedContainer.classList.remove('hidden');
      } else {
        deleteSelectedContainer.classList.add('hidden');
      }
    }
    
    function deleteSelectedLogs() {
      if (selectedLogs.size === 0) {
        alert("No logs selected for deletion");
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${selectedLogs.size} selected log(s)? This action cannot be undone.`)) {
        return;
      }
      
      // Convert Set to Array and sort in descending order to avoid index issues
      const indicesToDelete = Array.from(selectedLogs).sort((a, b) => b - a);
      
      // Delete logs from the array
      indicesToDelete.forEach(index => {
        userSessions.splice(index, 1);
      });
      
      // Clear selection
      selectedLogs.clear();
      
      // Save data and update UI
      saveUserData();
      updateAdminLogsTable();
      updateSelectedLogsDisplay();
      
      alert(`${indicesToDelete.length} log(s) deleted successfully`);
    }
    
    function showDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.remove('hidden');
    }
    
    function hideDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.add('hidden');
      document.getElementById('deletePassword').value = '';
    }
    
    function deleteAllLogs() {
      const password = document.getElementById('deletePassword').value;
      
      if (password !== 'admin123') {
        alert("Incorrect admin password");
        return;
      }
      
      if (!confirm("Are you sure you want to delete ALL user logs? This action cannot be undone.")) {
        return;
      }
      
      // Clear all user sessions
      userSessions = [];
      
      // Save data and update UI
      saveUserData();
      updateAdminLogsTable();
      hideDeleteConfirmation();
      
      alert("All user logs have been deleted");
    }
    
    function exportUserLogs() {
      let logText = "User Activity Logs\n";
      logText += "Generated: " + new Date().toLocaleString() + "\n\n";
      
      userSessions.forEach(session => {
        logText += `User: ${session.userName}\n`;
        logText += `Login Time: ${new Date(session.loginTime).toLocaleString()}\n`;
        logText += `Logout Time: ${session.logoutTime ? new Date(session.logoutTime).toLocaleString() : 'Active'}\n`;
        logText += `Duration: ${session.logoutTime ? Math.round((new Date(session.logoutTime) - new Date(session.loginTime)) / 60000) + ' min' : 'Active'}\n`;
        logText += `Search Count: ${session.searchCount || 0}\n`;
        logText += `Last Search: ${session.lastSearch || 'None'}\n`;
        logText += "----------------------------------------\n";
      });
      
      // Create and download text file
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'user_logs.txt';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function updateFileNicknameManager() {
      const manager = document.getElementById('fileNicknameManager');
      manager.innerHTML = '';
      
      availableFiles.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-nickname';
        
        fileDiv.innerHTML = `
          <label for="nickname-${file.name}">${file.name}:</label>
          <input type="text" id="nickname-${file.name}" value="${fileNicknames[file.name] || file.name}" placeholder="Enter nickname for ${file.name}">
        `;
        
        manager.appendChild(fileDiv);
      });
    }
    
    function saveFileNicknames() {
      availableFiles.forEach(file => {
        const nicknameInput = document.getElementById(`nickname-${file.name}`);
        if (nicknameInput) {
          fileNicknames[file.name] = nicknameInput.value.trim() || file.name;
        }
      });
      
      // Save data and update UI
      saveUserData();
      updateFileSelect();
      
      alert("File nicknames saved successfully!");
    }
    
    function resetFileNicknames() {
      availableFiles.forEach(file => {
        const simpleName = file.name.replace('.xlsx', '').replace('.xls', '').replace(/_/g, ' ');
        fileNicknames[file.name] = simpleName;
      });
      
      // Save data and update UI
      saveUserData();
      updateFileSelect();
      updateFileNicknameManager();
      
      alert("File nicknames reset to default!");
    }
    
    // Utility functions
    function logUserActivity(activity) {
      searchLogs.push({
        user: currentUserName || 'Unknown',
        activity: activity,
        timestamp: new Date().toISOString()
      });
      
      // Keep only the last 1000 logs to prevent storage issues
      if (searchLogs.length > 1000) {
        searchLogs = searchLogs.slice(-1000);
      }
      
      saveUserData();
    }
    
    function checkMobileDevice() {
      isMobileView = window.innerWidth <= 768;
      updateMobileView();
    }
    
    function toggleMobileView() {
      isMobileView = !isMobileView;
      updateMobileView();
      document.getElementById('mobileViewToggle').textContent = isMobileView ? "🖥️ Desktop View" : "📱 Mobile View";
    }
    
    function updateMobileView() {
      if (isMobileView) {
        document.body.classList.add('mobile-view');
      } else {
        document.body.classList.remove('mobile-view');
      }
    }
    
    function updateSearchHint() {
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      let hint = "";
      
      switch(searchType) {
        case "contains":
          hint = "Search for text that contains your keywords";
          break;
        case "exact":
          hint = "Search for exact matches of your keywords";
          break;
        case "startsWith":
          hint = "Search for text that starts with your keywords";
          break;
        case "endsWith":
          hint = "Search for text that ends with your keywords";
          break;
      }
      
      // Update placeholder text based on search type
      document.getElementById('searchInput').placeholder = hint;
    }
    
    // Export functionality
    function handleExportClick(type) {
      if (currentResults.length === 0) {
        alert("No data to export. Please perform a search first.");
        return;
      }
      
      currentExportType = type;
      
      // Show preview modal
      showExportPreview(type);
    }
    
    function showExportPreview(type) {
      const modal = document.getElementById('exportModal');
      const previewType = document.getElementById('previewType');
      const previewMessage = document.getElementById('previewMessage');
      const previewTableContainer = document.getElementById('previewTableContainer');
      const confirmExportBtn = document.getElementById('confirmExportBtn');
      
      previewType.textContent = type.toUpperCase();
      previewMessage.textContent = `Preview of data to be exported (${currentResults.length} rows):`;
      
      // Create preview table
      let previewHTML = `<table border="1" style="border-collapse: collapse; width: 100%;">`;
      
      // Add headers
      const columns = Object.keys(currentResults[0]).filter(col => 
        !col.startsWith('__') && col !== 'highlights' && columnVisibility[col] !== false
      );
      previewHTML += `<tr>`;
      previewHTML += `<th style="padding: 8px; background-color: #f0f0f0;">Source File</th>`;
      previewHTML += `<th style="padding: 8px; background-color: #f0f0f0;">Sheet Name</th>`;
      columns.forEach(col => {
        previewHTML += `<th style="padding: 8px; background-color: #f0f0f0;">${col}</th>`;
      });
      previewHTML += `</tr>`;
      
      // Add data rows (limit to 10 for preview)
      const previewRows = currentResults.slice(0, 10);
      previewRows.forEach(row => {
        previewHTML += `<tr>`;
        previewHTML += `<td style="padding: 8px;">${fileNicknames[row.__sourceFile] || row.__sourceFile}</td>`;
        previewHTML += `<td style="padding: 8px;">${row.__sheetName || 'N/A'}</td>`;
        columns.forEach(col => {
          previewHTML += `<td style="padding: 8px;">${row[col] || ''}</td>`;
        });
        previewHTML += `</tr>`;
      });
      
      previewHTML += `</table>`;
      
      if (currentResults.length > 10) {
        previewHTML += `<p style="text-align: center; margin-top: 10px;">... and ${currentResults.length - 10} more rows</p>`;
      }
      
      previewTableContainer.innerHTML = previewHTML;
      
      // Set up confirm button
      confirmExportBtn.onclick = function() {
        executeExport(type);
        closeExportPreview();
      };
      
      modal.style.display = 'block';
    }
    
    function closeExportPreview() {
      document.getElementById('exportModal').style.display = 'none';
      currentExportType = null;
    }
    
    function executeExport(type) {
      switch(type) {
        case 'excel':
          exportToExcel();
          break;
        case 'pdf':
          exportToPDF();
          break;
        case 'csv':
          exportToCSV();
          break;
        case 'print':
          printResults();
          break;
      }
    }
    
    function exportToExcel() {
      // Prepare data for export (remove internal columns and highlights property)
      const exportData = currentResults.map(row => {
        const { highlights, __sourceFile, __sheetName, ...data } = row;
        
        // Only include visible columns
        const filteredData = {};
        Object.keys(data).forEach(key => {
          if (columnVisibility[key] !== false) {
            filteredData[key] = data[key];
          }
        });
        
        return {
          'Source File': fileNicknames[__sourceFile] || __sourceFile,
          'Sheet Name': __sheetName || 'N/A',
          ...filteredData
        };
      });
      
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Search Results");
      XLSX.writeFile(wb, "search_results.xlsx");
    }
    
    function exportToPDF() {
      // Prepare data for export
      const exportData = currentResults.map(row => {
        const { highlights, __sourceFile, __sheetName, ...data } = row;
        
        // Only include visible columns
        const filteredData = {};
        Object.keys(data).forEach(key => {
          if (columnVisibility[key] !== false) {
            filteredData[key] = data[key];
          }
        });
        
        return {
          'Source File': fileNicknames[__sourceFile] || __sourceFile,
          'Sheet Name': __sheetName || 'N/A',
          ...filteredData
        };
      });
      
      // Get column headers
      const headers = Object.keys(exportData[0]);
      
      // Convert data to array format for jsPDF autoTable
      const body = exportData.map(row => {
        return headers.map(header => String(row[header] || ''));
      });
      
      // Create PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(16);
      doc.text('Search Results', 14, 15);
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);
      doc.text(`Total records: ${exportData.length}`, 14, 28);
      
      // Add table
      doc.autoTable({
        head: [headers],
        body: body,
        startY: 35,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [52, 152, 219] }
      });
      
      // Save PDF
      doc.save('search_results.pdf');
    }
    
    function exportToCSV() {
      // Prepare data for export (remove internal columns and highlights property)
      const exportData = currentResults.map(row => {
        const { highlights, __sourceFile, __sheetName, ...data } = row;
        
        // Only include visible columns
        const filteredData = {};
        Object.keys(data).forEach(key => {
          if (columnVisibility[key] !== false) {
            filteredData[key] = data[key];
          }
        });
        
        return {
          'Source File': fileNicknames[__sourceFile] || __sourceFile,
          'Sheet Name': __sheetName || 'N/A',
          ...filteredData
        };
      });
      
      const headers = Object.keys(exportData[0]);
      const csvContent = [
        headers.join(','),
        ...exportData.map(row => 
          headers.map(header => {
            const value = row[header];
            // Escape commas and quotes in values
            return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
              ? `"${value.replace(/"/g, '""')}"` 
              : value;
          }).join(',')
        )
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'search_results.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function printResults() {
      const printWindow = window.open('', '_blank');
      const columns = Object.keys(currentResults[0]).filter(col => 
        !col.startsWith('__') && col !== 'highlights' && columnVisibility[col] !== false
      );
      
      let printHTML = `
        <html>
          <head>
            <title>Search Results</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              table { border-collapse: collapse; width: 100%; margin-top: 10px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              @media print {
                body { margin: 0; }
                table { page-break-inside: auto; }
                tr { page-break-inside: avoid; page-break-after: auto; }
              }
            </style>
          </head>
          <body>
            <h1>Search Results</h1>
            <p>Generated: ${new Date().toLocaleString()}</p>
            <p>Total Results: ${currentResults.length}</p>
            <table>
              <thead>
                <tr>
                  <th>Source File</th>
                  <th>Sheet Name</th>
      `;
      
      columns.forEach(col => {
        printHTML += `<th>${col}</th>`;
      });
      
      printHTML += `</tr></thead><tbody>`;
      
      currentResults.forEach(row => {
        printHTML += `<tr>`;
        printHTML += `<td>${fileNicknames[row.__sourceFile] || row.__sourceFile}</td>`;
        printHTML += `<td>${row.__sheetName || 'N/A'}</td>`;
        columns.forEach(col => {
          printHTML += `<td>${row[col] || ''}</td>`;
        });
        printHTML += `</tr>`;
      });
      
      printHTML += `</tbody></table></body></html>`;
      
      printWindow.document.write(printHTML);
      printWindow.document.close();
      printWindow.print();
    }
    
    // Initialize the application
    window.onload = async function() {
      // Set current date/time
      document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
      
      // Load user data from localStorage
      loadUserData();
      
      // Load theme
      loadTheme();
      
      // Add event listeners for theme customization
      document.getElementById('bgColor').addEventListener('input', updateColorPreviews);
      document.getElementById('bgColor2').addEventListener('input', updateColorPreviews);
      document.getElementById('textColor').addEventListener('input', updateColorPreviews);
      document.getElementById('buttonColor').addEventListener('input', updateColorPreviews);
      document.getElementById('headerColor').addEventListener('input', updateColorPreviews);
      
      // Initial preview update
      updateColorPreviews();
      
      // Set up event listeners
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
      
      document.getElementById('userName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          setUserName();
        }
      });
      
      document.getElementById('adminPass').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          checkAdminLogin();
        }
      });
      
      // Add event listeners for search type changes
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updateSearchHint();
        });
      });
      
      // Initialize search hint
      updateSearchHint();
      
      // Check if we're on a mobile device
      checkMobileDevice();
      
      // Load files from GitHub
      await loadFilesFromGitHub();
      
      // Add window resize listener for mobile view
      window.addEventListener('resize', function() {
        checkMobileDevice();
      });
    };
  </script>
</body>
</html>
